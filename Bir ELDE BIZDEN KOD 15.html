<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Bir El de Bizden - YardÄ±m Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #f97316;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s, color 0.4s, font-size 0.3s, filter 0.3s;
            min-height: 100vh;
        }

        #main-content {
            padding-bottom: 5rem;
            min-height: calc(100vh - 4.5rem - 7rem);
        }

        #app-footer {
            height: 4.5rem;
        }

        .overflow-x-auto::-webkit-scrollbar {
            display: none;
        }

        .overflow-x-auto {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body.high-contrast {
            filter: grayscale(100%) contrast(150%);
            background-color: black !important;
            color: white !important;
        }

        body.high-contrast * {
            background-color: inherit !important;
            color: inherit !important;
            border-color: white !important;
            box-shadow: none !important;
        }

        body.high-contrast i {
            filter: invert(100%);
        }

        body.rtl-mode {
            direction: rtl;
            text-align: right;
        }

        .nav-btn {
            flex: 1;
            min-width: 0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(1.25rem);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-task {
            animation: slideIn 0.5s ease-out;
        }

        .task-card {
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-0.125rem);
            box-shadow: 0 0.625rem 1.56rem -0.31rem rgba(0, 0, 0, 0.1);
        }

        .product-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-card.selected {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .category-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .category-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .category-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
            transform: scale(1.05);
        }

        .tab-btn {
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .product-emoji {
            font-size: 2.5rem;
            line-height: 1;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 0.375rem;
            height: 0.375rem;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 0.625rem;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 0.625rem;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        #edevlet-login {
            background: linear-gradient(135deg, #005FAF 0%, #003d73 100%);
            transition: opacity 0.5s ease-out;
        }

        #edevlet-login.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .edevlet-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .kvkk-checkbox {
            accent-color: #005FAF;
        }

        .kvkk-link {
            color: #005FAF;
            text-decoration: underline;
            cursor: pointer;
        }

        .kvkk-link:hover {
            color: #003d73;
        }

        .kvkk-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .kvkk-modal-content {
            background: white;
            border-radius: 0.75rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 1.25rem 3.75rem rgba(0, 0, 0, 0.5);
        }

        .voice-float-btn {
            position: fixed;
            bottom: 6rem;
            right: 1rem;
            width: 3.5rem;
            height: 3.5rem;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0.25rem 1rem rgba(79, 70, 229, 0.5);
            z-index: 40;
            transition: all 0.3s;
        }

        .voice-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0.5rem 1.5rem rgba(79, 70, 229, 0.7);
        }

        .voice-float-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0.25rem 1rem rgba(16, 185, 129, 0.5);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0.5rem 1.5rem rgba(16, 185, 129, 0.8);
            }
        }



        .clickable-text {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-text:hover {
            background-color: rgba(79, 70, 229, 0.1);
            border-radius: 0.25rem;
        }


        .speak-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #4f46e5;
            color: white;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speak-btn:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .edevlet-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1.25rem 3.75rem rgba(0, 0, 0, 0.3);
        }

        .edevlet-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .edevlet-input:focus {
            outline: none;
            border-color: #005FAF;
            box-shadow: 0 0 0 3px rgba(0, 95, 175, 0.1);
        }

        .edevlet-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, #C8102E 0%, #9a0c24 100%);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .edevlet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.375rem 1.25rem rgba(200, 16, 46, 0.4);
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 0.625rem;
            height: 0.625rem;
            top: 0;
            z-index: 100;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(6.25rem);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }

        .qty-btn-large {
            min-width: 3rem;
            min-height: 3rem;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
            user-select: none;
        }

        .qty-btn-large:active {
            transform: scale(0.95);
        }

        .badge-card.earned {
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border: 2px solid #f59e0b;
        }

        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        @keyframes celebration-pop {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .celebration-modal {
            animation: celebration-pop 0.5s ease-out;
        }

        /* Mobile Shopping Modal Styles */
        @media (max-width: 768px) {
            .shopping-modal-mobile {
                position: fixed;
                inset: 0;
                z-index: 50;
                background-color: white;
            }

            .dark .shopping-modal-mobile {
                background-color: #1f2937;
            }
        }

        @media (min-width: 769px) {
            .shopping-modal-desktop {
                max-width: 90%;
                width: 1200px;
            }
        }

        .cart-floating-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 -0.25rem 0.375rem -0.063rem rgba(0, 0, 0, 0.1);
            z-index: 60;
            border-top: 0.063rem solid #e5e7eb;
        }

        .dark .cart-floating-bar {
            background: #1f2937;
            border-top: 0.063rem solid #374151;
        }

        .cart-slide-drawer {
            position: fixed;
            inset: 0;
            z-index: 70;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .cart-slide-drawer.open {
            opacity: 1;
            pointer-events: auto;
        }

        .cart-slide-content {
            width: 100%;
            max-height: 85vh;
            background: white;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
        }

        .dark .cart-slide-content {
            background: #1f2937;
        }

        .cart-slide-drawer.open .cart-slide-content {
            transform: translateY(0);
        }

        .products-grid-mobile {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        @media (min-width: 768px) {
            .products-grid-mobile {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .bottom-cart-bar {
            position: fixed;
            bottom: 5rem;
            left: 0;
            right: 0;
            max-width: 32rem;
            margin: 0 auto;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 1rem 1.5rem;
            box-shadow: 0 -0.25rem 1rem rgba(0, 0, 0, 0.2);
            z-index: 60;
            border-radius: 1rem 1rem 0 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .bottom-cart-bar:active {
            transform: scale(0.98);
        }

        .dark .bottom-cart-bar {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .payment-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .payment-modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 400px;
            width: 100%;
            padding: 2rem;
            box-shadow: 0 1.25rem 3.75rem rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .dark .payment-modal-content {
            background: #1f2937;
        }

        .qr-code-container {
            width: 200px;
            height: 200px;
            margin: 1.5rem auto;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .qr-code-placeholder {
            width: 180px;
            height: 180px;
            background: linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6),
                linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .nfc-pulse {
            width: 80px;
            height: 80px;
            margin: 1rem auto;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: nfc-pulse-anim 1.5s infinite;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }

        @keyframes nfc-pulse-anim {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes payment-success-flash {
            0% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(16, 185, 129, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        .payment-success-flash {
            animation: payment-success-flash 0.8s ease-out;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', /* Indigo-600 */
                        'secondary': '#f97316', /* Orange-500 */
                    },
                }
            }
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors">

    <!-- e-Devlet Login Gateway -->
    <div id="edevlet-login" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="edevlet-card p-8 w-full max-w-md">
            <!-- Logo and Title -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-16 h-16 bg-[#C8102E] rounded-full flex items-center justify-center mr-3">
                        <span class="text-white text-2xl font-bold">ğŸ‡¹ğŸ‡·</span>
                    </div>
                    <div class="text-left">
                        <h1 class="text-xl font-bold text-[#005FAF]">TÃ¼rkiye.gov.tr</h1>
                        <p class="text-sm text-gray-500">e-Devlet KapÄ±sÄ±</p>
                    </div>
                </div>
                <h2 class="text-lg font-semibold text-gray-800">Bir El de Bizden'e GiriÅŸ</h2>
                <p class="text-sm text-gray-500 mt-1">GÃ¼venli giriÅŸ iÃ§in lÃ¼tfen bilgilerinizi giriniz</p>
            </div>

            <!-- Login Form -->
            <form id="edevlet-form" onsubmit="handleEDevletLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">T.C. Kimlik No</label>
                    <input type="text" id="tc-kimlik" class="edevlet-input"
                        placeholder="11 haneli T.C. Kimlik numaranÄ±z" maxlength="11" inputmode="numeric" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">e-Devlet Åifresi</label>
                    <input type="password" id="edevlet-sifre" class="edevlet-input" placeholder="Åifrenizi giriniz"
                        required>
                </div>

                <!-- KVKK Consent Checkbox -->
                <div class="pt-2 pb-1">
                    <div class="flex items-start">
                        <input type="checkbox" id="kvkk-consent" class="kvkk-checkbox mt-1 w-4 h-4"
                            onchange="toggleLoginButton()">
                        <label for="kvkk-consent" class="ml-2 text-xs text-gray-700 leading-relaxed">
                            6698 sayÄ±lÄ± KVKK kapsamÄ±nda kiÅŸisel verilerimin iÅŸlenmesini
                            <span class="kvkk-link" onclick="openKVKKModal(event)">okudum</span> ve onaylÄ±yorum.
                            <button type="button" onclick="speakKVKKText(event)" class="speak-btn ml-2">ğŸ”Š Metni
                                Oku</button>
                        </label>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" id="login-btn" class="edevlet-btn" disabled>
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                                </path>
                            </svg>
                            GiriÅŸ Yap
                        </span>
                    </button>
                </div>
            </form>

            <!-- Footer -->
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">Bu uygulama TÃœBÄ°TAK 2204A projesi kapsamÄ±nda geliÅŸtirilmiÅŸtir.</p>
                <p class="text-xs text-gray-400 mt-1">Demo amaÃ§lÄ± simÃ¼lasyondur.</p>
            </div>
        </div>
    </div>

    <!-- KVKK Modal -->
    <div id="kvkk-modal" class="kvkk-modal" style="display: none;">
        <div class="kvkk-modal-content">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-gray-800">KiÅŸisel Verilerin KorunmasÄ± HakkÄ±nda Bilgilendirme</h2>
                <button onclick="closeKVKKModal()"
                    class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div class="text-sm text-gray-700 space-y-3 leading-relaxed">
                <p><strong>6698 SayÄ±lÄ± KiÅŸisel Verilerin KorunmasÄ± Kanunu (KVKK) UyarÄ±nca AydÄ±nlatma Metni</strong></p>

                <p>Ä°ÅŸbu metinde "Bir El de Bizden" platformunun, 6698 sayÄ±lÄ± KiÅŸisel Verilerin KorunmasÄ± Kanunu ("KVKK")
                    uyarÄ±nca veri sorumlusu sÄ±fatÄ±yla, kiÅŸisel verilerinizi hangi amaÃ§larla iÅŸleyeceÄŸi, kiÅŸisel
                    verilerin kimlere ve hangi amaÃ§larla aktarÄ±labileceÄŸi, kiÅŸisel veri toplamanÄ±n yÃ¶ntemi ve hukuki
                    sebebi ile veri sahibi olarak haklarÄ±nÄ±zÄ±n neler olduÄŸu konularÄ±nda sizleri bilgilendirmeyi
                    amaÃ§lamaktadÄ±r.</p>

                <p><strong>1. Veri Sorumlusu</strong></p>
                <p>KiÅŸisel verileriniz, "Bir El de Bizden" platformu tarafÄ±ndan aÅŸaÄŸÄ±da aÃ§Ä±klanan kapsamda
                    iÅŸlenebilecektir.</p>

                <p><strong>2. KiÅŸisel Verilerin Ä°ÅŸlenme AmacÄ±</strong></p>
                <p>Toplanan kiÅŸisel verileriniz; sosyal yardÄ±mlaÅŸma ve dayanÄ±ÅŸma faaliyetlerini yÃ¼rÃ¼tmek, gÃ¶nÃ¼llÃ¼lÃ¼k
                    hizmetlerini koordine etmek, platform Ã¼zerinden gerÃ§ekleÅŸtirilen talep ve hizmet eÅŸleÅŸtirmelerini
                    saÄŸlamak, iletiÅŸim kurmak, kimlik doÄŸrulama iÅŸlemlerini gerÃ§ekleÅŸtirmek, hukuki ve idari
                    yÃ¼kÃ¼mlÃ¼lÃ¼klerin yerine getirilmesi amaÃ§larÄ±yla iÅŸlenebilecektir.</p>

                <p><strong>3. KiÅŸisel Veri ToplamanÄ±n YÃ¶ntemi ve Hukuki Sebebi</strong></p>
                <p>KiÅŸisel verileriniz, elektronik ortamda, e-Devlet entegrasyonu aracÄ±lÄ±ÄŸÄ±yla veya platform Ã¼zerinden
                    doÄŸrudan sizin tarafÄ±nÄ±zdan girilen bilgiler vasÄ±tasÄ±yla toplanmaktadÄ±r. Bu veriler, KVKK'nÄ±n 5. ve
                    6. maddelerinde belirtilen "kanunlarda aÃ§Ä±kÃ§a Ã¶ngÃ¶rÃ¼lmesi", "bir hakkÄ±n tesisi, kullanÄ±lmasÄ± veya
                    korunmasÄ± iÃ§in veri iÅŸlemenin zorunlu olmasÄ±" ve "aÃ§Ä±k rÄ±zanÄ±zÄ±n bulunmasÄ±" hukuki sebeplerine
                    dayanÄ±larak iÅŸlenmektedir.</p>

                <p><strong>4. Veri Sahibinin HaklarÄ±</strong></p>
                <p>KVKK'nÄ±n 11. maddesi uyarÄ±nca veri sahipleri olarak aÅŸaÄŸÄ±daki haklara sahipsiniz:</p>
                <ul class="list-disc ml-5 space-y-1">
                    <li>KiÅŸisel verilerinizin iÅŸlenip iÅŸlenmediÄŸini Ã¶ÄŸrenme,</li>
                    <li>KiÅŸisel verileriniz iÅŸlenmiÅŸse buna iliÅŸkin bilgi talep etme,</li>
                    <li>KiÅŸisel verilerinizin iÅŸlenme amacÄ±nÄ± ve bunlarÄ±n amacÄ±na uygun kullanÄ±lÄ±p kullanÄ±lmadÄ±ÄŸÄ±nÄ±
                        Ã¶ÄŸrenme,</li>
                    <li>Yurt iÃ§inde veya yurt dÄ±ÅŸÄ±nda kiÅŸisel verilerinizin aktarÄ±ldÄ±ÄŸÄ± Ã¼Ã§Ã¼ncÃ¼ kiÅŸileri bilme,</li>
                    <li>KiÅŸisel verilerinizin eksik veya yanlÄ±ÅŸ iÅŸlenmiÅŸ olmasÄ± halinde bunlarÄ±n dÃ¼zeltilmesini isteme,
                    </li>
                    <li>KVKK'nÄ±n 7. maddesinde Ã¶ngÃ¶rÃ¼len ÅŸartlar Ã§erÃ§evesinde kiÅŸisel verilerinizin silinmesini veya yok
                        edilmesini isteme,</li>
                    <li>KiÅŸisel verilerinizin dÃ¼zeltilmesi, silinmesi ya da yok edilmesi halinde bu iÅŸlemlerin kiÅŸisel
                        verilerinizin aktarÄ±ldÄ±ÄŸÄ± Ã¼Ã§Ã¼ncÃ¼ kiÅŸilere bildirilmesini isteme,</li>
                    <li>Ä°ÅŸlenen verilerin mÃ¼nhasÄ±ran otomatik sistemler vasÄ±tasÄ±yla analiz edilmesi suretiyle aleyhinize
                        bir sonucun ortaya Ã§Ä±kmasÄ±na itiraz etme,</li>
                    <li>KiÅŸisel verilerinizin kanuna aykÄ±rÄ± olarak iÅŸlenmesi sebebiyle zarara uÄŸramanÄ±z halinde zararÄ±n
                        giderilmesini talep etme.</li>
                </ul>

                <p class="mt-4 text-xs text-gray-500 italic">Bu metin demo amaÃ§lÄ± hazÄ±rlanmÄ±ÅŸ Ã¶rnek bir KVKK metnidir.
                </p>
            </div>
            <div class="mt-6 text-center">
                <button onclick="closeKVKKModal()"
                    class="px-6 py-2 bg-[#005FAF] text-white rounded-lg hover:bg-[#003d73] transition">AnladÄ±m</button>
            </div>
        </div>
    </div>

    <!-- Voice Assistant Floating Button -->
    <button id="voice-assistant-btn" class="voice-float-btn" onclick="toggleVoiceAssistant()" style="display: none;">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
            </path>
        </svg>
    </button>

    <div id="app-wrapper"
        class="flex flex-col min-h-screen max-w-lg mx-auto shadow-xl bg-white dark:bg-gray-800 hidden">

        <!-- 1. SABÄ°T BAÅLIK ALANI (HEADER) - Ayarlar, Dil ve Arama Ã‡ubuÄŸu -->
        <header id="app-header"
            class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-20 shadow-sm">

            <!-- Ayarlar ve Dil SeÃ§imi AlanÄ± -->
            <div class="flex justify-between items-center mb-3">

                <div class="flex items-center space-x-3">
                    <!-- Ayarlar DÃ¼ÄŸmesi (Sol Ãœst) -->
                    <button onclick="openSettingsModal()"
                        class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <!-- Dil SeÃ§imi -->
                    <select id="lang-selector" onchange="changeLanguage(this.value)"
                        class="text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg p-1.5 border-none focus:ring-primary focus:border-primary transition">
                        <option value="tr">TÃ¼rkÃ§e</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    </select>
                </div>

                <!-- Bildirim AlanÄ± -->
                <div
                    class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                    <i data-lucide="bell" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i>
                </div>

            </div>

            <!-- Arama Ã‡ubuÄŸu -->
            <div class="relative">
                <input type="text" id="search-input" data-i18n-placeholder="search_placeholder"
                    placeholder="YardÄ±m, ilaÃ§, market ihtiyacÄ± ara..."
                    class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-primary focus:border-primary transition duration-150 text-sm text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500">
                <i data-lucide="search"
                    class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"></i>
            </div>
        </header>

        <!-- 2. KAYDIRILABÄ°LÄ°R ANA Ä°Ã‡ERÄ°K ALANI (MAIN CONTENT) -->
        <main id="main-content" class="flex-grow p-4 overflow-y-auto">

            <!-- KullanÄ±cÄ± Bilgisi - SadeleÅŸtirilmiÅŸ -->
            <div
                class="mb-4 p-3 bg-gradient-to-r from-primary/10 to-secondary/10 dark:from-primary/20 dark:to-secondary/20 rounded-lg text-center">
                <h1 class="text-2xl font-bold text-primary dark:text-primary-300 mb-2">Bir El de BÄ°ZDEN</h1>
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">KullanÄ±cÄ± Tipi: <span
                        id="user-type-display">Hizmet Alan</span></p>
            </div>

            <!-- Sayfa Ä°Ã§eriÄŸi Dinamik Alan -->
            <div id="page-content">
                <!-- Ä°Ã§erik buraya yÃ¼klenir -->
            </div>


        </main>

        <!-- 3. SABÄ°T ALT GEZÄ°NME Ã‡UBUÄU (BOTTOM NAVIGATION BAR) -->
        <footer id="app-footer"
            class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-2xl z-20">
            <nav class="flex justify-around items-center h-full pt-2">
                <!-- Ana Sayfa -->
                <button onclick="viewChange('home', this)"
                    class="nav-btn flex flex-col items-center transition duration-150 text-primary">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-xs mt-1 font-medium" data-i18n="nav_home">Ana Sayfa</span>
                </button>
                <!-- GÃ¶revler (Sadece GÃ¶nÃ¼llÃ¼ KullanÄ±cÄ±larda GÃ¶rÃ¼nÃ¼r) -->
                <button onclick="viewChange('tasks', this)"
                    class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary transition duration-150 hidden"
                    id="tasks-nav-btn">
                    <i data-lucide="target" class="w-6 h-6"></i>
                    <span class="text-xs mt-1" data-i18n="nav_tasks">GÃ¶revler</span>
                </button>
                <!-- Ä°stekler/Sepet -->
                <button onclick="viewChange('requests', this)"
                    class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary transition duration-150">
                    <i data-lucide="list-checks" class="w-6 h-6"></i>
                    <span class="text-xs mt-1" data-i18n="nav_requests">Ä°steklerim</span>
                </button>
                <!-- Hesap/Profil -->
                <button onclick="viewChange('account', this)"
                    class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary transition duration-150">
                    <i data-lucide="user" class="w-6 h-6"></i>
                    <span class="text-xs mt-1" data-i18n="nav_account">Hesap</span>
                </button>
            </nav>
        </footer>

        <!-- Modal KapsayÄ±cÄ±sÄ± (EkranÄ±n ortasÄ±nda gÃ¶sterilecek) -->
        <div id="modal-container"
            class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-30 hidden items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
            <!-- Modal iÃ§eriÄŸi buraya dinamik olarak eklenecek -->
        </div>
    </div>

    <!-- EKSTRA: GÃ¶revler EkranÄ± iÃ§in HTML Template -->
    <template id="task-template">
        <div
            class="task-card bg-white dark:bg-gray-700 p-4 rounded-xl shadow-lg border border-gray-200 dark:border-gray-600 mb-3 new-task">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center mb-2">
                        <i data-lucide="shopping-bag" class="w-5 h-5 text-emerald-500 mr-2"></i>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 truncate">AlÄ±ÅŸveriÅŸ Talebi
                        </h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-1" id="task-items">Ã–ÄŸeler: </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" id="task-address">Adres: </p>
                    <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 mb-2">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                        <span id="task-time">SÃ¼re: 15-20 dakika</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                        <i data-lucide="user" class="w-3 h-3 mr-1"></i>
                        <span id="task-user">YaÅŸlÄ±: </span>
                    </div>
                </div>
                <span
                    class="text-xs font-semibold py-1 px-3 rounded-full bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300 ml-3 flex-shrink-0">Bekliyor</span>
            </div>

            <div class="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-gray-600 mt-3">
                <span class="text-xs text-gray-500 dark:text-gray-400">Talep No: <span id="task-id"></span></span>
                <button onclick="acceptTask(this)"
                    class="px-4 py-2 text-sm font-medium text-white bg-emerald-500 rounded-lg hover:bg-emerald-600 transition flex items-center">
                    <i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>
                    Kabul Et
                </button>
            </div>
        </div>
    </template>

    <!-- Uygulama MantÄ±ÄŸÄ± (Firebase kaldÄ±rÄ±ldÄ±, localStorage kullanÄ±lÄ±yor) -->
    <script>
        // --- GLOBAL & STORAGE MANTIKLARI ---
        const REQUESTS_KEY = 'app-requests';
        const THEME_KEY = 'app-theme';
        const FONT_SIZE_KEY = 'app-font-size';
        const CONTRAST_KEY = 'app-contrast';
        const LANGUAGE_KEY = 'app-lang';
        const USER_INFO_KEY = 'app-user-info';
        const VOLUNTEER_TASKS_KEY = 'volunteer-tasks';
        const PRODUCTS_DB_KEY = 'app-products-db';

        let currentLang = 'tr';
        let currentFontSize = parseFloat(localStorage.getItem(FONT_SIZE_KEY)) || 1.0;
        let isContrastMode = localStorage.getItem(CONTRAST_KEY) === 'true';
        let currentView = 'home';
        let currentUserInfo = JSON.parse(localStorage.getItem(USER_INFO_KEY)) || {
            role: 'helper'
        };
        let volunteerTasks = JSON.parse(localStorage.getItem(VOLUNTEER_TASKS_KEY)) || [];
        let taskInterval = null;

        // YENÄ°: GÃ¶rsel ÃœrÃ¼n SeÃ§im Sistemi iÃ§in deÄŸiÅŸkenler
        let selectedProducts = [];
        let currentCategory = 'all';
        let productSearchQuery = '';
        let shoppingModalActiveTab = 'visual'; // 'visual' veya 'text'

        // UI ElemanlarÄ±
        const modalContainer = document.getElementById('modal-container');
        const pageContent = document.getElementById('page-content');
        const navButtons = document.querySelectorAll('.nav-btn');
        const body = document.body;
        const tasksNavBtn = document.getElementById('tasks-nav-btn');

        // --- YENÄ°: GÃ–RSEL ÃœRÃœN VERÄ°TABANI ---
        const productDatabase = [
            // Meyve & Sebzeler
            { id: 'prod_1', name: 'Elma', category: 'meyve_sebze', emoji: 'ğŸ', defaultUnit: 'Kilogram', keywords: ['meyve', 'elma', 'yeÅŸil elma', 'kÄ±rmÄ±zÄ± elma'] },
            { id: 'prod_2', name: 'Muz', category: 'meyve_sebze', emoji: 'ğŸŒ', defaultUnit: 'Kilogram', keywords: ['meyve', 'muz', 'olgun muz'] },
            { id: 'prod_3', name: 'Portakal', category: 'meyve_sebze', emoji: 'ğŸŠ', defaultUnit: 'Kilogram', keywords: ['meyve', 'portakal', 'turuncu', 'c vitamini'] },
            { id: 'prod_4', name: 'Ã‡ilek', category: 'meyve_sebze', emoji: 'ğŸ“', defaultUnit: 'Kilogram', keywords: ['meyve', 'Ã§ilek', 'kÄ±rmÄ±zÄ± meyve'] },
            { id: 'prod_5', name: 'ÃœzÃ¼m', category: 'meyve_sebze', emoji: 'ğŸ‡', defaultUnit: 'Kilogram', keywords: ['meyve', 'Ã¼zÃ¼m', 'yeÅŸil Ã¼zÃ¼m', 'siyah Ã¼zÃ¼m'] },
            { id: 'prod_6', name: 'Domates', category: 'meyve_sebze', emoji: 'ğŸ…', defaultUnit: 'Kilogram', keywords: ['sebze', 'domates', 'salata', 'kÄ±rmÄ±zÄ±'] },
            { id: 'prod_7', name: 'SalatalÄ±k', category: 'meyve_sebze', emoji: 'ğŸ¥’', defaultUnit: 'Kilogram', keywords: ['sebze', 'salatalÄ±k', 'hÄ±yar', 'yeÅŸil'] },
            { id: 'prod_8', name: 'Patates', category: 'meyve_sebze', emoji: 'ğŸ¥”', defaultUnit: 'Kilogram', keywords: ['sebze', 'patates', 'yemek', 'kÄ±zartma'] },
            { id: 'prod_9', name: 'SoÄŸan', category: 'meyve_sebze', emoji: 'ğŸ§…', defaultUnit: 'Kilogram', keywords: ['sebze', 'soÄŸan', 'kuru soÄŸan', 'yemek'] },
            { id: 'prod_10', name: 'HavuÃ§', category: 'meyve_sebze', emoji: 'ğŸ¥•', defaultUnit: 'Kilogram', keywords: ['sebze', 'havuÃ§', 'turuncu', 'salata'] },

            // SÃ¼t ÃœrÃ¼nleri
            { id: 'prod_11', name: 'SÃ¼t', category: 'sut_urunleri', emoji: 'ğŸ¥›', defaultUnit: 'Litre', keywords: ['sÃ¼t', 'sÃ¼t Ã¼rÃ¼nÃ¼', 'iÃ§ecek', 'beyaz'] },
            { id: 'prod_12', name: 'YoÄŸurt', category: 'sut_urunleri', emoji: 'ğŸ¥£', defaultUnit: 'Kilogram', keywords: ['yoÄŸurt', 'sÃ¼t Ã¼rÃ¼nÃ¼', 'probiyotik'] },
            { id: 'prod_13', name: 'Peynir', category: 'sut_urunleri', emoji: 'ğŸ§€', defaultUnit: 'Kilogram', keywords: ['peynir', 'sÃ¼t Ã¼rÃ¼nÃ¼', 'kahvaltÄ±', 'beyaz peynir'] },
            { id: 'prod_14', name: 'TereyaÄŸÄ±', category: 'sut_urunleri', emoji: 'ğŸ§ˆ', defaultUnit: 'paket', keywords: ['tereyaÄŸÄ±', 'sÃ¼t Ã¼rÃ¼nÃ¼', 'yemek', 'kahvaltÄ±'] },
            { id: 'prod_15', name: 'Yumurta', category: 'sut_urunleri', emoji: 'ğŸ¥š', defaultUnit: 'dÃ¼zine', keywords: ['yumurta', 'kahvaltÄ±', 'protein', 'beyaz'] },

            // Temel GÄ±da
            { id: 'prod_16', name: 'Ekmek', category: 'temel_gida', emoji: 'ğŸ', defaultUnit: 'Tane', keywords: ['ekmek', 'temel gÄ±da', 'somun ekmek'] },
            { id: 'prod_17', name: 'PirinÃ§', category: 'temel_gida', emoji: 'ğŸš', defaultUnit: 'Kilogram', keywords: ['pirinÃ§', 'pilav', 'temel gÄ±da'] },
            { id: 'prod_18', name: 'Makarna', category: 'temel_gida', emoji: 'ğŸ', defaultUnit: 'paket', keywords: ['makarna', 'spagetti', 'temel gÄ±da'] },
            { id: 'prod_19', name: 'Bulgur', category: 'temel_gida', emoji: 'ğŸŒ¾', defaultUnit: 'Kilogram', keywords: ['bulgur', 'pilav', 'temel gÄ±da'] },
            { id: 'prod_20', name: 'Un', category: 'temel_gida', emoji: 'ğŸŒ¾', defaultUnit: 'Kilogram', keywords: ['un', 'buÄŸday unu', 'temel gÄ±da'] },
            { id: 'prod_21', name: 'Åeker', category: 'temel_gida', emoji: 'ğŸ¬', defaultUnit: 'Kilogram', keywords: ['ÅŸeker', 'toz ÅŸeker', 'tatlandÄ±rÄ±cÄ±'] },
            { id: 'prod_22', name: 'Tuz', category: 'temel_gida', emoji: 'ğŸ§‚', defaultUnit: 'paket', keywords: ['tuz', 'baharat', 'temel gÄ±da'] },
            { id: 'prod_23', name: 'Zeytin', category: 'temel_gida', emoji: 'ğŸ«’', defaultUnit: 'Kilogram', keywords: ['zeytin', 'siyah zeytin', 'yeÅŸil zeytin'] },

            // Ä°Ã§ecekler
            { id: 'prod_24', name: 'Su', category: 'icecek', emoji: 'ğŸ’§', defaultUnit: 'Litre', keywords: ['su', 'iÃ§ecek', 'pet ÅŸiÅŸe'] },
            { id: 'prod_25', name: 'Ã‡ay', category: 'icecek', emoji: 'ğŸµ', defaultUnit: 'paket', keywords: ['Ã§ay', 'siyah Ã§ay', 'demlik Ã§ay'] },
            { id: 'prod_26', name: 'Kahve', category: 'icecek', emoji: 'â˜•', defaultUnit: 'paket', keywords: ['kahve', 'tÃ¼rk kahvesi', 'instant kahve'] },
            { id: 'prod_27', name: 'Meyve Suyu', category: 'icecek', emoji: 'ğŸ§ƒ', defaultUnit: 'Litre', keywords: ['meyve suyu', 'portakal suyu', 'iÃ§ecek'] },

            // Et & BalÄ±k
            { id: 'prod_28', name: 'Tavuk', category: 'et_balik', emoji: 'ğŸ—', defaultUnit: 'Kilogram', keywords: ['tavuk', 'et', 'beyaz et'] },
            { id: 'prod_29', name: 'KÄ±rmÄ±zÄ± Et', category: 'et_balik', emoji: 'ğŸ¥©', defaultUnit: 'Kilogram', keywords: ['et', 'kÄ±rmÄ±zÄ± et', 'dana eti', 'kuzu eti'] },
            { id: 'prod_30', name: 'BalÄ±k', category: 'et_balik', emoji: 'ğŸŸ', defaultUnit: 'Kilogram', keywords: ['balÄ±k', 'deniz Ã¼rÃ¼nÃ¼', 'protein'] },
            { id: 'prod_31', name: 'Sosis', category: 'et_balik', emoji: 'ğŸŒ­', defaultUnit: 'paket', keywords: ['sosis', 'ÅŸarkÃ¼teri', 'hazÄ±r gÄ±da'] },

            // Temizlik
            { id: 'prod_32', name: 'Sabun', category: 'temizlik', emoji: 'ğŸ§¼', defaultUnit: 'Tane', keywords: ['sabun', 'el sabunu', 'kiÅŸisel bakÄ±m'] },
            { id: 'prod_33', name: 'Åampuan', category: 'temizlik', emoji: 'ğŸ§´', defaultUnit: 'Tane', keywords: ['ÅŸampuan', 'saÃ§ bakÄ±mÄ±', 'kiÅŸisel bakÄ±m'] },
            { id: 'prod_34', name: 'DiÅŸ Macunu', category: 'temizlik', emoji: 'ğŸ¦·', defaultUnit: 'tÃ¼p', keywords: ['diÅŸ macunu', 'aÄŸÄ±z bakÄ±mÄ±', 'kiÅŸisel bakÄ±m'] },
            { id: 'prod_35', name: 'Ã‡amaÅŸÄ±r Suyu', category: 'temizlik', emoji: 'ğŸ§´', defaultUnit: 'Litre', keywords: ['Ã§amaÅŸÄ±r suyu', 'temizlik', 'dezenfektan'] },
            { id: 'prod_36', name: 'BulaÅŸÄ±k DeterjanÄ±', category: 'temizlik', emoji: 'ğŸ§½', defaultUnit: 'Litre', keywords: ['bulaÅŸÄ±k deterjanÄ±', 'temizlik', 'sÄ±vÄ± deterjan'] },
            { id: 'prod_37', name: 'Ã‡amaÅŸÄ±r DeterjanÄ±', category: 'temizlik', emoji: 'ğŸ‘•', defaultUnit: 'paket', keywords: ['Ã§amaÅŸÄ±r deterjanÄ±', 'temizlik', 'toz deterjan'] },

            // AtÄ±ÅŸtÄ±rmalÄ±klar
            { id: 'prod_38', name: 'BiskÃ¼vi', category: 'atistirmalik', emoji: 'ğŸª', defaultUnit: 'paket', keywords: ['biskÃ¼vi', 'kurabiye', 'atÄ±ÅŸtÄ±rmalÄ±k'] },
            { id: 'prod_39', name: 'Ã‡ikolata', category: 'atistirmalik', emoji: 'ğŸ«', defaultUnit: 'paket', keywords: ['Ã§ikolata', 'tatlÄ±', 'atÄ±ÅŸtÄ±rmalÄ±k'] },
            { id: 'prod_40', name: 'Cips', category: 'atistirmalik', emoji: 'ğŸ¥”', defaultUnit: 'paket', keywords: ['cips', 'patates cipsi', 'atÄ±ÅŸtÄ±rmalÄ±k'] },
            { id: 'prod_41', name: 'KuruyemiÅŸ', category: 'atistirmalik', emoji: 'ğŸ¥œ', defaultUnit: 'Kilogram', keywords: ['kuruyemiÅŸ', 'fÄ±ndÄ±k', 'fÄ±stÄ±k', 'ceviz'] },

            // Konserve & HazÄ±r GÄ±da
            { id: 'prod_42', name: 'Konserve', category: 'konserve', emoji: 'ğŸ¥«', defaultUnit: 'kutu', keywords: ['konserve', 'hazÄ±r gÄ±da', 'fasulye', 'mÄ±sÄ±r'] },
            { id: 'prod_43', name: 'KetÃ§ap', category: 'konserve', emoji: 'ğŸ…', defaultUnit: 'ÅŸiÅŸe', keywords: ['ketÃ§ap', 'sos', 'hazÄ±r gÄ±da'] },
            { id: 'prod_44', name: 'Mayonez', category: 'konserve', emoji: 'ğŸ¥£', defaultUnit: 'ÅŸiÅŸe', keywords: ['mayonez', 'sos', 'hazÄ±r gÄ±da'] },

            // DondurulmuÅŸ GÄ±da
            { id: 'prod_45', name: 'Dondurma', category: 'dondurulmus', emoji: 'ğŸ¨', defaultUnit: 'kutu', keywords: ['dondurma', 'tatlÄ±', 'soÄŸuk'] },
            { id: 'prod_46', name: 'DondurulmuÅŸ Sebze', category: 'dondurulmus', emoji: 'ğŸ¥¦', defaultUnit: 'paket', keywords: ['dondurulmuÅŸ', 'sebze', 'mÄ±sÄ±r', 'bezelye'] },

            // KiÅŸisel BakÄ±m
            { id: 'prod_47', name: 'Tuvalet KaÄŸÄ±dÄ±', category: 'kisisel_bakim', emoji: 'ğŸ§»', defaultUnit: 'paket', keywords: ['tuvalet kaÄŸÄ±dÄ±', 'kaÄŸÄ±t', 'temizlik'] },
            { id: 'prod_48', name: 'KaÄŸÄ±t Havlu', category: 'kisisel_bakim', emoji: 'ğŸ“„', defaultUnit: 'paket', keywords: ['kaÄŸÄ±t havlu', 'temizlik', 'mutfak kaÄŸÄ±dÄ±'] },
            { id: 'prod_49', name: 'Ped', category: 'kisisel_bakim', emoji: 'ğŸ©¹', defaultUnit: 'paket', keywords: ['ped', 'kadÄ±n bakÄ±mÄ±', 'kiÅŸisel bakÄ±m'] },
            { id: 'prod_50', name: 'Islak Mendil', category: 'kisisel_bakim', emoji: 'ğŸ§»', defaultUnit: 'paket', keywords: ['Ä±slak mendil', 'temizlik', 'kiÅŸisel bakÄ±m'] },

            // Ev & YaÅŸam
            { id: 'prod_51', name: 'Pil', category: 'ev_yasam', emoji: 'ğŸ”‹', defaultUnit: 'Tane', keywords: ['pil', 'kalem pil', 'aa pil', 'aaa pil'] },
            { id: 'prod_52', name: 'Ampul', category: 'ev_yasam', emoji: 'ğŸ’¡', defaultUnit: 'Tane', keywords: ['ampul', 'led ampul', 'aydÄ±nlatma'] },
            { id: 'prod_53', name: 'Ã‡Ã¶p TorbasÄ±', category: 'ev_yasam', emoji: 'ğŸ—‘ï¸', defaultUnit: 'paket', keywords: ['Ã§Ã¶p torbasÄ±', 'naylon poÅŸet', 'temizlik'] },

            // DiÄŸer
            { id: 'prod_54', name: 'Bebek Bezi', category: 'diger', emoji: 'ğŸ‘¶', defaultUnit: 'paket', keywords: ['bebek bezi', 'Ã§ocuk', 'bebek'] },
            { id: 'prod_55', name: 'Mama', category: 'diger', emoji: 'ğŸ¼', defaultUnit: 'kutu', keywords: ['mama', 'bebek mamasÄ±', 'Ã§ocuk'] },
            { id: 'prod_56', name: 'Yemek TabaÄŸÄ±', category: 'diger', emoji: 'ğŸ½ï¸', defaultUnit: 'adet', keywords: ['tabak', 'plastik tabak', 'kaÄŸÄ±t tabak'] }
        ];

        // Kategori bilgileri
        const categories = [
            { id: 'all', name: 'TÃ¼m ÃœrÃ¼nler', emoji: 'ğŸ›’', color: 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300' },
            { id: 'meyve_sebze', name: 'Meyve & Sebze', emoji: 'ğŸ¥¦', color: 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300' },
            { id: 'sut_urunleri', name: 'SÃ¼t ÃœrÃ¼nleri', emoji: 'ğŸ¥›', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300' },
            { id: 'temel_gida', name: 'Temel GÄ±da', emoji: 'ğŸ', color: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300' },
            { id: 'icecek', name: 'Ä°Ã§ecekler', emoji: 'ğŸ§ƒ', color: 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/50 dark:text-cyan-300' },
            { id: 'et_balik', name: 'Et & BalÄ±k', emoji: 'ğŸ—', color: 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300' },
            { id: 'temizlik', name: 'Temizlik', emoji: 'ğŸ§¼', color: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300' },
            { id: 'atistirmalik', name: 'AtÄ±ÅŸtÄ±rmalÄ±k', emoji: 'ğŸª', color: 'bg-pink-100 text-pink-700 dark:bg-pink-900/50 dark:text-pink-300' },
            { id: 'kisisel_bakim', name: 'KiÅŸisel BakÄ±m', emoji: 'ğŸ§´', color: 'bg-teal-100 text-teal-700 dark:bg-teal-900/50 dark:text-teal-300' },
            { id: 'ev_yasam', name: 'Ev & YaÅŸam', emoji: 'ğŸ ', color: 'bg-gray-100 text-gray-700 dark:bg-gray-900/50 dark:text-gray-300' }
        ];

        // YENÄ°: Rastgele gÃ¶rev oluÅŸturma iÃ§in veriler (eksik olan veriler eklendi)
        const shoppingItems = [
            ['ğŸ¥› SÃ¼t (2L), ğŸ Ekmek, ğŸ§€ Beyaz Peynir', 'AtatÃ¼rk Cad. No:45, Merkez'],
            ['ğŸ’Š Tansiyon Ä°lacÄ±, ğŸ©¹ Yara BandÄ±', 'Cumhuriyet Mah. 3. Sok. No:12'],
            ['ğŸ Elma (1kg), ğŸŒ Muz, ğŸ¥• HavuÃ§', 'Ä°stiklal Mah. Ã‡iÃ§ek Sok. No:8'],
            ['ğŸ¥š Yumurta (30\'lu), ğŸ§ˆ TereyaÄŸÄ±', 'Fatih Cad. No:67, Kat:2'],
            ['ğŸ’§ Su (5L x 4), ğŸµ Ã‡ay', 'YÄ±ldÄ±z Sitesi A Blok D:15'],
            ['ğŸ— Tavuk But (1kg), ğŸ… Domates', 'BahÃ§elievler Mah. No:23'],
            ['ğŸ§» Tuvalet KaÄŸÄ±dÄ±, ğŸ§¼ El Sabunu', 'GÃ¼neÅŸ Apt. No:5, D:3'],
            ['ğŸ¥” Patates (2kg), ğŸ§… SoÄŸan (1kg)', 'YeÅŸil Sok. No:18'],
            ['ğŸš PirinÃ§ (1kg), ğŸŒ¾ Bulgur', 'BarÄ±ÅŸ Mah. 7. Cad. No:42'],
            ['â˜• Kahve, ğŸª BiskÃ¼vi', 'Merkez Mah. Okul Sok. No:9']
        ];

        const elderlyNames = [
            'Fatma Teyze (78)',
            'Ahmet Amca (82)',
            'AyÅŸe Nine (75)',
            'Mehmet Dede (80)',
            'Hatice Teyze (77)',
            'Ali Amca (85)',
            'Zeynep Nine (73)',
            'Mustafa Dede (79)',
            'Emine Teyze (81)',
            'Hasan Amca (76)'
        ];

        // YENÄ°: Rozet sistemi
        const badgeSystem = [
            { id: 'first_step', icon: 'ğŸŒ±', name: 'Ä°lk AdÄ±m', desc: 'Ä°lk gÃ¶revinizi tamamladÄ±nÄ±z', threshold: 1 },
            { id: 'helpful_neighbor', icon: 'ğŸ¡', name: 'YardÄ±msever KomÅŸu', desc: '5 gÃ¶rev tamamlandÄ±', threshold: 5 },
            { id: 'fast_responder', icon: 'âš¡', name: 'HÄ±zlÄ± YanÄ±tÃ§Ä±', desc: '10 gÃ¶rev tamamlandÄ±', threshold: 10 },
            { id: 'reliable_soul', icon: 'ğŸ’', name: 'GÃ¼venilir Ruh', desc: '20 gÃ¶rev tamamlandÄ±', threshold: 20 },
            { id: 'community_hero', icon: 'ğŸ¦¸', name: 'Topluluk KahramanÄ±', desc: '50 gÃ¶rev tamamlandÄ±', threshold: 50 }
        ];

        // === TEXT-TO-SPEECH (TTS) FUNCTIONALITY ===
        let voiceAssistantActive = false;
        let currentSpeech = null;

        // Helper function to speak text using Web Speech API
        window.speakText = function (text, forceSpeak = false) {
            if (!('speechSynthesis' in window)) {
                console.warn('Text-to-Speech not supported in this browser');
                return;
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            if (!text || text.trim() === '') return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'tr-TR'; // Turkish language
            utterance.rate = 0.9; // Slightly slower for elderly users
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            // Get Turkish voice if available
            const voices = window.speechSynthesis.getVoices();
            const turkishVoice = voices.find(voice => voice.lang.startsWith('tr'));
            if (turkishVoice) {
                utterance.voice = turkishVoice;
            }

            currentSpeech = utterance;
            window.speechSynthesis.speak(utterance);

            // Visual feedback
            const voiceBtn = document.getElementById('voice-assistant-btn');
            if (voiceBtn) {
                voiceBtn.classList.add('active');
            }

            utterance.onend = function () {
                if (voiceBtn) {
                    voiceBtn.classList.remove('active');
                }
                currentSpeech = null;
            };

            utterance.onerror = function (event) {
                console.error('Speech synthesis error:', event);
                if (voiceBtn) {
                    voiceBtn.classList.remove('active');
                }
                currentSpeech = null;
            };
        };

        // Toggle voice assistant mode
        window.toggleVoiceAssistant = function () {
            voiceAssistantActive = !voiceAssistantActive;
            const voiceBtn = document.getElementById('voice-assistant-btn');

            if (voiceAssistantActive) {
                document.body.classList.add('voice-mode-active');
                speakText('Sesli asistan aktif. Okumak istediÄŸiniz metne tÄ±klayÄ±n.');
                attachGlobalVoiceListener();
            } else {
                window.speechSynthesis.cancel();
                document.body.classList.remove('voice-mode-active');
                speakText('Sesli asistan kapatÄ±ldÄ±.');
                setTimeout(() => {
                    detachGlobalVoiceListener();
                }, 1500);
            }
        };

        let globalVoiceClickHandler = null;

        function attachGlobalVoiceListener() {
            if (globalVoiceClickHandler) return;

            globalVoiceClickHandler = function (event) {
                if (!voiceAssistantActive) return;

                window.speechSynthesis.cancel();

                let target = event.target;

                if (target.tagName === 'BUTTON') {
                    if (!target.classList.contains('product-card')) {
                        const buttonText = target.getAttribute('aria-label') || target.innerText?.trim() || target.textContent?.trim();
                        if (buttonText && buttonText.length > 0) {
                            speakText(cleanTextForSpeech(buttonText));
                        }
                        return;
                    }
                }

                if (target.classList.contains('product-card')) {
                    const nameElement = target.querySelector('.font-semibold') || target.querySelector('.font-medium');
                    const unitElement = target.querySelector('.text-xs');

                    if (nameElement) {
                        let productName = nameElement.textContent.trim();
                        let productUnit = unitElement?.textContent.trim() || '';

                        let speechText = productName;
                        if (productUnit) {
                            const expandedUnit = expandUnit(productUnit);
                            speechText += '. ' + expandedUnit;
                        }

                        speakText(cleanTextForSpeech(speechText));
                    }
                    return;
                }

                let textContent = target.textContent?.trim() || '';
                if (textContent.length < 2) {
                    target = target.closest('p, h1, h2, h3, h4, h5, h6, li, span, button, label, .task-card, .product-card');
                    if (target) {
                        textContent = target.textContent?.trim() || '';
                    }
                }

                if (textContent && textContent.length > 1) {
                    speakText(cleanTextForSpeech(textContent));
                }
            };

            document.addEventListener('click', globalVoiceClickHandler, true);
        }

        function detachGlobalVoiceListener() {
            if (globalVoiceClickHandler) {
                document.removeEventListener('click', globalVoiceClickHandler, true);
                globalVoiceClickHandler = null;
            }
        }

        function highlightElement(element) {
            if (!element) return;

            element.classList.add('voice-highlight');

            setTimeout(() => {
                element.classList.remove('voice-highlight');
            }, 300);
        }

        function cleanTextForSpeech(text) {
            if (!text) return '';

            text = text.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '');

            text = text.replace(/\s+/g, ' ').trim();

            return text;
        }

        function expandUnit(unitText) {
            const unitMap = {
                'kg': 'Kilogram',
                'lt': 'Litre',
                'adet': 'Tane',
                'paket': 'Paket',
                'dÃ¼zine': 'DÃ¼zine',
                'ÅŸiÅŸe': 'ÅiÅŸe',
                'kutu': 'Kutu',
                'torba': 'Torba'
            };

            return unitMap[unitText.toLowerCase()] || unitText;
        }

        function enableTextClicking() {
        }

        function disableTextClicking() {
        }

        function handleTextClick(event) {

            const textToRead = event.currentTarget.textContent.trim();
            if (textToRead) {
                speakText(cleanTextForSpeech(textToRead));
            }
        }

        // KVKK Modal Functions
        window.openKVKKModal = function (event) {
            event.preventDefault();
            document.getElementById('kvkk-modal').style.display = 'flex';
        };

        window.closeKVKKModal = function () {
            document.getElementById('kvkk-modal').style.display = 'none';
        };

        // Enable/disable login button based on KVKK consent
        window.toggleLoginButton = function () {
            const checkbox = document.getElementById('kvkk-consent');
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = !checkbox.checked;
        };

        // Speak KVKK text
        window.speakKVKKText = function (event) {
            event.preventDefault();
            event.stopPropagation();
            const kvkkText = '6698 sayÄ±lÄ± KiÅŸisel Verilerin KorunmasÄ± Kanunu kapsamÄ±nda kiÅŸisel verilerimin iÅŸlenmesini okudum ve onaylÄ±yorum.';
            speakText(kvkkText);
        };

        // Auto-read KVKK on login screen load (with fallback if blocked)
        function tryAutoReadKVKK() {
            if (!('speechSynthesis' in window)) return;

            setTimeout(() => {
                const kvkkText = '6698 sayÄ±lÄ± KVKK kapsamÄ±nda kiÅŸisel verilerimin iÅŸlenmesini okudum ve onaylÄ±yorum. Onay kutusunu iÅŸaretleyiniz.';
                try {
                    speakText(kvkkText);
                } catch (error) {
                    console.log('Auto-read blocked by browser. User can click the button.');
                }
            }, 1000);
        }

        window.toggleVoiceDictation = function () {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('TarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor.');
                return;
            }

            const textarea = document.getElementById('request-details');
            const voiceBtn = document.getElementById('voice-dictation-btn');
            const statusDiv = document.getElementById('dictation-status');

            if (!textarea || !voiceBtn) return;

            if (isListening) {
                if (speechRecognition) {
                    speechRecognition.stop();
                }
                isListening = false;
                voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                voiceBtn.classList.add('bg-primary', 'hover:bg-indigo-600');
                if (statusDiv) {
                    statusDiv.classList.add('hidden');
                }
                return;
            }

            if (!speechRecognition) {
                speechRecognition = new SpeechRecognition();
                speechRecognition.lang = 'tr-TR';
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;

                speechRecognition.onstart = function () {
                    isListening = true;
                    voiceBtn.classList.remove('bg-primary', 'hover:bg-indigo-600');
                    voiceBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    if (statusDiv) {
                        statusDiv.textContent = 'ğŸ™ï¸ Dinleniyor... KonuÅŸun.';
                        statusDiv.classList.remove('hidden');
                        statusDiv.classList.add('text-red-500');
                    }
                };

                speechRecognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    const currentValue = textarea.value.trim();
                    textarea.value = currentValue ? currentValue + ' ' + transcript : transcript;

                    if (statusDiv) {
                        statusDiv.textContent = 'âœ“ Metin eklendi.';
                        statusDiv.classList.remove('text-red-500');
                        statusDiv.classList.add('text-green-500');
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                        }, 2000);
                    }
                };

                speechRecognition.onerror = function (event) {
                    console.error('Speech recognition error:', event.error);
                    if (statusDiv) {
                        statusDiv.textContent = 'âš ï¸ Ses tanÄ±ma hatasÄ±. Tekrar deneyin.';
                        statusDiv.classList.remove('text-red-500');
                        statusDiv.classList.add('text-orange-500');
                    }
                };

                speechRecognition.onend = function () {
                    isListening = false;
                    voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    voiceBtn.classList.add('bg-primary', 'hover:bg-indigo-600');
                };
            }

            try {
                speechRecognition.start();
            } catch (error) {
                console.error('Could not start speech recognition:', error);
                if (statusDiv) {
                    statusDiv.textContent = 'âš ï¸ Ses tanÄ±ma baÅŸlatÄ±lamadÄ±.';
                    statusDiv.classList.remove('hidden', 'text-red-500');
                    statusDiv.classList.add('text-orange-500');
                }
            }
        };

        window.toggleAddressDictation = function () {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('TarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor.');
                return;
            }

            const textarea = document.getElementById('user-address');
            const voiceBtn = document.getElementById('address-voice-btn');
            const statusDiv = document.getElementById('address-dictation-status');

            if (!textarea || !voiceBtn) return;

            if (isListening) {
                if (speechRecognition) {
                    speechRecognition.stop();
                }
                isListening = false;
                voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                voiceBtn.classList.add('bg-primary', 'hover:bg-indigo-600');
                if (statusDiv) {
                    statusDiv.classList.add('hidden');
                }
                return;
            }

            if (!speechRecognition) {
                speechRecognition = new SpeechRecognition();
                speechRecognition.lang = 'tr-TR';
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;

                speechRecognition.onstart = function () {
                    isListening = true;
                    voiceBtn.classList.remove('bg-primary', 'hover:bg-indigo-600');
                    voiceBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    if (statusDiv) {
                        statusDiv.textContent = 'ğŸ™ï¸ Dinleniyor... KonuÅŸun.';
                        statusDiv.classList.remove('hidden');
                        statusDiv.classList.add('text-red-500');
                    }
                };

                speechRecognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    const currentValue = textarea.value.trim();
                    textarea.value = currentValue ? currentValue + ' ' + transcript : transcript;

                    if (statusDiv) {
                        statusDiv.textContent = 'âœ“ Metin eklendi.';
                        statusDiv.classList.remove('text-red-500');
                        statusDiv.classList.add('text-green-500');
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                        }, 2000);
                    }
                };

                speechRecognition.onerror = function (event) {
                    console.error('Speech recognition error:', event.error);
                    if (statusDiv) {
                        statusDiv.textContent = 'âš ï¸ Ses tanÄ±ma hatasÄ±. Tekrar deneyin.';
                        statusDiv.classList.remove('text-red-500');
                        statusDiv.classList.add('text-orange-500');
                    }
                };

                speechRecognition.onend = function () {
                    isListening = false;
                    voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    voiceBtn.classList.add('bg-primary', 'hover:bg-indigo-600');
                };
            }

            try {
                speechRecognition.start();
            } catch (error) {
                console.error('Could not start speech recognition:', error);
                if (statusDiv) {
                    statusDiv.textContent = 'âš ï¸ Ses tanÄ±ma baÅŸlatÄ±lamadÄ±.';
                    statusDiv.classList.remove('hidden', 'text-red-500');
                    statusDiv.classList.add('text-orange-500');
                }
            }
        };

        window.saveUserAddress = function () {
            const addressTextarea = document.getElementById('user-address');
            if (!addressTextarea) return;

            const newAddress = addressTextarea.value.trim();
            if (!newAddress) {
                alert('LÃ¼tfen geÃ§erli bir adres giriniz.');
                return;
            }

            currentUserInfo.address = newAddress;
            localStorage.setItem(USER_INFO_KEY, JSON.stringify(currentUserInfo));

            const tempMessage = document.createElement('div');
            tempMessage.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            tempMessage.textContent = 'âœ“ Adres baÅŸarÄ±yla kaydedildi!';
            document.body.appendChild(tempMessage);

            setTimeout(() => {
                tempMessage.remove();
            }, 2000);
        };

        window.openEmergencyConfirmModal = function () {
            const modalContent = `
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl transform transition-all duration-300 scale-100 border-4 border-red-600">
                    <div class="text-center mb-4">
                        <span class="text-6xl mb-3 block">ğŸš¨</span>
                        <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-3">ACÄ°L UYARI</h2>
                    </div>
                    <p class="text-lg text-gray-800 dark:text-gray-100 mb-6 text-center font-semibold">112 Acil Servisi aramak Ã¼zeresiniz.<br>Emin misiniz?</p>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="closeModal()" class="px-6 py-4 text-lg font-bold text-white bg-red-600 rounded-xl hover:bg-red-700 transition shadow-lg">
                            HAYIR
                        </button>
                        <a href="tel:112" class="px-6 py-4 text-lg font-bold text-white bg-green-600 rounded-xl hover:bg-green-700 transition text-center shadow-lg">
                            EVET, ARA
                        </a>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // e-Devlet Login Handler
        window.handleEDevletLogin = function (event) {
            event.preventDefault();
            const tcKimlik = document.getElementById('tc-kimlik').value.trim();
            const sifre = document.getElementById('edevlet-sifre').value.trim();
            const kvkkConsent = document.getElementById('kvkk-consent').checked;

            if (!kvkkConsent) {
                speakText('LÃ¼tfen KVKK onayÄ±nÄ± iÅŸaretleyiniz.');
                return;
            }

            if (tcKimlik.length > 0 && sifre.length > 0) {
                // SimÃ¼le edilmiÅŸ giriÅŸ - herhangi bir deÄŸer kabul et
                sessionStorage.setItem('eDevletLoggedIn', 'true');
                sessionStorage.setItem('eDevletUser', tcKimlik);

                // Stop any ongoing speech
                window.speechSynthesis.cancel();

                // Login ekranÄ±nÄ± fade-out yap
                const loginScreen = document.getElementById('edevlet-login');
                loginScreen.classList.add('fade-out');

                speakText('GiriÅŸ baÅŸarÄ±lÄ±. HoÅŸ geldiniz.');

                // Ana uygulamayÄ± gÃ¶ster
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    document.getElementById('app-wrapper').classList.remove('hidden');
                    // Show voice assistant button
                    document.getElementById('voice-assistant-btn').style.display = 'flex';
                }, 500);
            }
        };

        // e-Devlet oturum kontrolÃ¼
        function checkEDevletSession() {
            const isLoggedIn = sessionStorage.getItem('eDevletLoggedIn') === 'true';
            if (isLoggedIn) {
                document.getElementById('edevlet-login').style.display = 'none';
                document.getElementById('app-wrapper').classList.remove('hidden');
                document.getElementById('voice-assistant-btn').style.display = 'flex';
            } else {
                // Try to auto-read KVKK text when login screen loads
                setTimeout(() => {
                    tryAutoReadKVKK();
                }, 500);
            }
        }

        // Konfeti animasyonu
        function showConfetti() {
            const colors = ['#C8102E', '#005FAF', '#FFD700', '#10B981', '#F97316'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        // Kutlama modalÄ± gÃ¶ster
        function showCelebrationModal(taskName) {
            showConfetti();

            const completedTasks = volunteerTasks.filter(t => t.status === 'accepted').length;
            let earnedBadge = null;
            for (const badge of badgeSystem) {
                if (completedTasks === badge.threshold) {
                    earnedBadge = badge;
                    break;
                }
            }

            let badgeHtml = '';
            if (earnedBadge) {
                badgeHtml = `
                    <div class="mt-4 p-4 bg-yellow-100 rounded-xl border-2 border-yellow-400">
                        <p class="text-center text-yellow-800 font-bold">ğŸ–ï¸ Yeni Rozet KazandÄ±nÄ±z!</p>
                        <div class="text-center mt-2">
                            <span class="text-4xl">${earnedBadge.icon}</span>
                            <p class="font-bold text-yellow-700 mt-1">${earnedBadge.name}</p>
                        </div>
                    </div>
                `;
            }

            const celebrationContent = `
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-full max-w-sm shadow-2xl celebration-modal text-center">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Tebrikler!</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">GÃ¶revi baÅŸarÄ±yla kabul ettiniz. Bir yaÅŸlÄ±mÄ±zÄ±n hayatÄ±na dokundunuz!</p>
                    <div class="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-600 p-3 rounded-lg">
                        Tamamlanan Toplam GÃ¶rev: <strong class="text-emerald-500">${completedTasks}</strong>
                    </div>
                    ${badgeHtml}
                    <button onclick="closeModal()" class="mt-6 px-6 py-2 bg-emerald-500 text-white rounded-full font-medium hover:bg-emerald-600 transition">Harika!</button>
                </div>
            `;

            modalContainer.innerHTML = celebrationContent;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        }

        // --- INTERNATIONALIZATION (i18n) DATA ---
        const i18n = {
            'tr': {
                'title': 'Bir El de Bizden - YardÄ±m Platformu',
                'nav_home': 'Ana Sayfa', 'nav_tasks': 'GÃ¶revler', 'nav_requests': 'Ä°steklerim', 'nav_account': 'Hesap', 'search_placeholder': 'YardÄ±m, ilaÃ§, market ihtiyacÄ± ara...',
                'qa_request': 'YardÄ±m Ä°ste', 'qa_medication': 'Ä°laÃ§ HatÄ±rlatÄ±cÄ±', 'qa_shopping': 'AlÄ±ÅŸveriÅŸ Listesi', 'qa_volunteer': 'GÃ¶nÃ¼llÃ¼ Ol', 'home_title': 'Ã‡evrenizdeki Son Ä°stekler',
                'tasks_title': 'GÃ¶nÃ¼llÃ¼ GÃ¶revleri', 'tasks_info': 'Bu sayfada, size en yakÄ±n bÃ¶lgedeki yaÅŸlÄ±larÄ±n alÄ±ÅŸveriÅŸ taleplerini gÃ¶rebilir ve kabul edebilirsiniz.', 'no_tasks': 'HenÃ¼z aktif gÃ¶rev bulunmuyor. Yeni gÃ¶revler her 2-3 dakikada bir burada belirecek.', 'task_items': 'Ã–ÄŸeler', 'task_address': 'Adres', 'task_time': 'SÃ¼re', 'task_elder': 'YaÅŸlÄ±', 'task_accept': 'Kabul Et', 'task_accepted': 'GÃ¶rev Kabul Edildi', 'task_completed': 'Bu gÃ¶revi tamamladÄ±nÄ±z!',
                'requests_title': 'Ä°steklerim & YardÄ±m KayÄ±tlarÄ±m', 'requests_info': 'Bu sayfada, gÃ¶nderdiÄŸiniz ve tamamladÄ±ÄŸÄ±nÄ±z tÃ¼m kiÅŸisel yardÄ±m kayÄ±tlarÄ±nÄ±zÄ± gÃ¶rebilirsiniz.', 'loading_requests': 'Ä°stekler yÃ¼kleniyor...', 'no_requests': 'HenÃ¼z bir istek bulunmamaktadÄ±r. Ä°lk isteÄŸi siz oluÅŸturun!',
                'account_title': 'HesabÄ±m', 'account_role_helper': 'KullanÄ±cÄ± Tipi: Hizmet Alan', 'account_role_volunteer': 'KullanÄ±cÄ± Tipi: GÃ¶nÃ¼llÃ¼', 'stats_completed': 'Tamamlanan YardÄ±m', 'stats_hours': 'GÃ¶nÃ¼llÃ¼ Saat', 'stats_pending': 'Bekleyen Ä°stek', 'menu_address': 'Adres Bilgilerim', 'menu_support': 'YardÄ±m & Destek', 'menu_logout': 'Ã‡Ä±kÄ±ÅŸ Yap',
                'modal_req_title': 'Yeni YardÄ±m Ä°steÄŸi', 'modal_med_title': 'Yeni Ä°laÃ§ HatÄ±rlatÄ±cÄ±sÄ±', 'modal_shop_title': 'AlÄ±ÅŸveriÅŸ Listesi HazÄ±rlama', 'modal_cancel': 'Ä°ptal', 'modal_send': 'GÃ¶nder', 'modal_save': 'Kaydet', 'modal_delete': 'Sil', 'request_details_placeholder': 'Detaylar: Neye ihtiyacÄ±nÄ±z var? Adresiniz?', 'med_name_placeholder': 'Ä°laÃ§ AdÄ± (Ã¶rn: Parol)', 'med_time_placeholder': 'Saat (Ã¶rn: 09:00, 14:00)', 'shop_item_placeholder': 'Ã–ÄŸe (Ã¶rn: Ekmek, SÃ¼t)', 'modal_volunteer_title': 'GÃ¶nÃ¼llÃ¼ BaÅŸvurusu', 'volunteer_desc': 'TopluluÄŸumuza katÄ±larak yardÄ±m eli uzatmak ister misiniz? LÃ¼tfen kÄ±saca kendinizden ve yardÄ±m edebileceÄŸiniz alanlardan bahsedin.', 'volunteer_placeholder': 'Ã–rn: Hafta sonlarÄ± alÄ±ÅŸveriÅŸ, ev onarÄ±mÄ±, teknolojik destek verebilirim.',
                'modal_delete_confirm': 'Bu isteÄŸi kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?', 'sent_by': 'GÃ¶nderen', 'date': 'Tarih', 'user_you': 'Siz', 'status_pending': 'Beklemede', 'status_complete': 'TamamlandÄ±', 'status_applied': 'BaÅŸvuru YapÄ±ldÄ±',
                'settings_title': 'Ayarlar', 'dark_mode': 'KaranlÄ±k Mod', 'account_security': 'Hesap GÃ¼venliÄŸi', 'notification_prefs': 'Bildirim Tercihleri', 'privacy_policy': 'Gizlilik PolitikasÄ±', 'close': 'Kapat',
                'version': 'Uygulama Versiyonu: 1.0.0 (SÃ¼rdÃ¼rÃ¼lebilirlik)',
                'font_size_title': 'YazÄ± Boyutu AyarÄ±', 'font_size_increase': 'BÃ¼yÃ¼t', 'font_size_decrease': 'KÃ¼Ã§Ã¼lt', 'current_font_size': 'Mevcut Boyut:',
                'contrast_mode_title': 'Kontrast Modu', 'contrast_toggle': 'KontrastÄ± ArtÄ±r',
                'help_title': 'Uygulama YardÄ±mÄ± ve Ã–zellikleri',
                'help_emergency': 'Acil YardÄ±m (GÃ¶nÃ¼llÃ¼ Ã‡aÄŸrÄ±)', 'help_emergency_desc': 'Hayati tehlike arz eden veya anlÄ±k mÃ¼dahale gerektiren durumlar iÃ§in Ã§evrenizdeki en yakÄ±n gÃ¶nÃ¼llÃ¼lere hÄ±zla Ã§aÄŸrÄ± gÃ¶nderir.',
                'help_general': 'Genel Destek Ä°steÄŸi', 'help_general_desc': 'Market alÄ±ÅŸveriÅŸi, evde kÃ¼Ã§Ã¼k tamiratlar, ilaÃ§ alma gibi acil olmayan gÃ¼nlÃ¼k ihtiyaÃ§larÄ±nÄ±z iÃ§in destek talep edebilirsiniz.',
                'help_medication': 'Ä°laÃ§ Takibi', 'help_medication_desc': 'DÃ¼zenli kullandÄ±ÄŸÄ±nÄ±z ilaÃ§larÄ±n saatlerini kaydederek bildirim alabilir ve hatÄ±rlatmalarÄ±nÄ±zÄ± otomatik olarak oluÅŸturabilirsiniz.',
                'help_shopping': 'AlÄ±ÅŸveriÅŸ Listesi', 'help_shopping_desc': 'DetaylÄ± alÄ±ÅŸveriÅŸ listenizi hazÄ±rlayarak bir gÃ¶nÃ¼llÃ¼nÃ¼n sizin adÄ±nÄ±za market veya eczane alÄ±ÅŸveriÅŸi yapmasÄ±nÄ± saÄŸlayabilirsiniz.',
                'volunteer_approved': 'Tebrikler! GÃ¶nÃ¼llÃ¼ baÅŸvurunuz onaylandÄ±. ArtÄ±k bir gÃ¶nÃ¼llÃ¼sÃ¼nÃ¼z.',
                'volunteer_notification': 'ğŸ‰ GÃ¶nÃ¼llÃ¼ BaÅŸvurusu OnaylandÄ±!',
                'volunteer_status': 'GÃ¶nÃ¼llÃ¼',
                'helper_status': 'Hizmet Alan',

                // YENÄ°: GÃ¶rsel ÃœrÃ¼n SeÃ§im Sistemi iÃ§in metinler
                'visual_shopping_title': 'GÃ¶rsel ÃœrÃ¼n SeÃ§imi',
                'text_shopping_title': 'Metin GiriÅŸi',
                'search_products': 'ÃœrÃ¼n ara...',
                'categories': 'Kategoriler',
                'selected_items': 'SeÃ§ilen ÃœrÃ¼nler',
                'quantity': 'Miktar',
                'note': 'Not',
                'add_note': 'Not ekle',
                'remove': 'KaldÄ±r',
                'no_products_selected': 'HenÃ¼z Ã¼rÃ¼n seÃ§mediniz',
                'add_selected_to_list': 'SeÃ§ilenleri Listeye Ekle',
                'clear_selection': 'SeÃ§imi Temizle',
                'total_items': 'Toplam ÃœrÃ¼n',
                'items': 'Ã¼rÃ¼n',
                'no_results': 'AramanÄ±zla eÅŸleÅŸen Ã¼rÃ¼n bulunamadÄ±',
                'shopping_list': 'AlÄ±ÅŸveriÅŸ Listesi',
                'general_notes': 'Genel Notlar',
                'general_notes_placeholder': 'Ek notlar, Ã¶zel istekler, teslimat adresi detaylarÄ±...',
                'product_unit_kg': 'kg',
                'product_unit_litre': 'lt',
                'product_unit_piece': 'adet',
                'product_unit_pack': 'paket',
                'product_unit_dozen': 'dÃ¼zine',
                'product_unit_bottle': 'ÅŸiÅŸe',
                'product_unit_box': 'kutu',
                'product_unit_bag': 'torba'
            },
            'en': {
                'title': 'One Hand From Us - Aid Platform',
                'nav_home': 'Home', 'nav_tasks': 'Tasks', 'nav_requests': 'My Requests', 'nav_account': 'Account', 'search_placeholder': 'Search for aid, medicine, grocery needs...',
                'qa_request': 'Request Aid', 'qa_medication': 'Medication Reminder', 'qa_shopping': 'Shopping List', 'qa_volunteer': 'Volunteer', 'home_title': 'Latest Requests Near You',
                'tasks_title': 'Volunteer Tasks', 'tasks_info': 'On this page, you can see and accept shopping requests from elderly people in your nearest area.', 'no_tasks': 'No active tasks yet. New tasks will appear here every 2-3 minutes.', 'task_items': 'Items', 'task_address': 'Address', 'task_time': 'Duration', 'task_elder': 'Elderly', 'task_accept': 'Accept', 'task_accepted': 'Task Accepted', 'task_completed': 'You completed this task!',
                'requests_title': 'My Requests & Aid Records', 'requests_info': 'On this page, you can see all your personal aid records you have sent and completed.', 'loading_requests': 'Requests loading...', 'no_requests': 'No requests found yet. Be the first to create one!',
                'account_title': 'My Account', 'account_role_helper': 'User Type: Service Receiver', 'account_role_volunteer': 'User Type: Volunteer', 'stats_completed': 'Completed Aid', 'stats_hours': 'Volunteer Hours', 'stats_pending': 'Pending Requests', 'menu_address': 'Address Information', 'menu_support': 'Help & Support', 'menu_logout': 'Log Out',
                'modal_req_title': 'New Aid Request', 'modal_med_title': 'New Medication Reminder', 'modal_shop_title': 'Prepare Shopping List', 'modal_cancel': 'Cancel', 'modal_send': 'Send', 'modal_save': 'Save', 'modal_delete': 'Delete', 'request_details_placeholder': 'Details: What do you need? Your address?', 'med_name_placeholder': 'Medication Name (e.g., Parol)', 'med_time_placeholder': 'Time (e.g., 09:00, 14:00)', 'shop_item_placeholder': 'Item (e.g., Bread, Milk)', 'modal_volunteer_title': 'Volunteer Application', 'volunteer_desc': 'Would you like to join our community and lend a helping hand? Please briefly mention yourself and the areas you can help with.', 'volunteer_placeholder': 'E.g.: I can help with shopping, home repairs, or technical support on weekends.',
                'modal_delete_confirm': 'Are you sure you want to permanently delete this request?', 'sent_by': 'Sent By', 'date': 'Date', 'user_you': 'You', 'status_pending': 'Pending', 'status_complete': 'Completed', 'status_applied': 'Applied',
                'settings_title': 'Settings', 'dark_mode': 'Dark Mode', 'account_security': 'Account Security', 'notification_prefs': 'Notification Preferences', 'privacy_policy': 'Privacy Policy', 'close': 'Close',
                'version': 'Application Version: 1.0.0 (Sustainability)',
                'font_size_title': 'Font Size Setting', 'font_size_increase': 'Increase', 'font_size_decrease': 'Decrease', 'current_font_size': 'Current Size:',
                'contrast_mode_title': 'Contrast Mode', 'contrast_toggle': 'Increase Contrast',
                'help_title': 'Application Help and Features',
                'help_emergency': 'Emergency Aid (Volunteer Call)', 'help_emergency_desc': 'Quickly sends a call to the nearest volunteers in your area for life-threatening or immediate intervention situations.',
                'help_general': 'General Support Request', 'help_general_desc': 'You can request support for non-urgent daily needs such as grocery shopping, minor home repairs, or picking up medication.',
                'help_medication': 'Medication Tracking', 'help_medication_desc': 'You can receive notifications by saving the times of your regular medications and automatically create your reminders.',
                'help_shopping': 'Shopping List', 'help_shopping_desc': 'By preparing your detailed shopping list, you can allow a volunteer to do grocery or pharmacy shopping on your behalf.',
                'volunteer_approved': 'Congratulations! Your volunteer application has been approved. You are now a volunteer.',
                'volunteer_notification': 'ğŸ‰ Volunteer Application Approved!',
                'volunteer_status': 'Volunteer',
                'helper_status': 'Service Receiver',

                // YENÄ°: GÃ¶rsel ÃœrÃ¼n SeÃ§im Sistemi iÃ§in metinler
                'visual_shopping_title': 'Visual Product Selection',
                'text_shopping_title': 'Text Input',
                'search_products': 'Search products...',
                'categories': 'Categories',
                'selected_items': 'Selected Items',
                'quantity': 'Quantity',
                'note': 'Note',
                'add_note': 'Add note',
                'remove': 'Remove',
                'no_products_selected': 'No products selected yet',
                'add_selected_to_list': 'Add Selected to List',
                'clear_selection': 'Clear Selection',
                'total_items': 'Total Items',
                'items': 'items',
                'no_results': 'No products matching your search',
                'shopping_list': 'Shopping List',
                'general_notes': 'General Notes',
                'general_notes_placeholder': 'Additional notes, special requests, delivery address details...',
                'product_unit_kg': 'kg',
                'product_unit_litre': 'lt',
                'product_unit_piece': 'piece',
                'product_unit_pack': 'pack',
                'product_unit_dozen': 'dozen',
                'product_unit_bottle': 'bottle',
                'product_unit_box': 'box',
                'product_unit_bag': 'bag'
            }
        };

        // --- DÄ°L YÃ–NETÄ°MÄ° ---
        window.getTranslation = (key) => {
            return i18n[currentLang] && i18n[currentLang][key] ? i18n[currentLang][key] : `[${key}]`;
        };

        window.applyLocalization = () => {
            // HTML metinlerini gÃ¼ncelle
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = getTranslation(key);
            });
            // Placeholder'larÄ± gÃ¼ncelle
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = getTranslation(key);
            });
            // Title'Ä± gÃ¼ncelle
            document.title = getTranslation('title');

            // KullanÄ±cÄ± tipini gÃ¼ncelle
            updateUserTypeDisplay();

            // ArapÃ§a iÃ§in RTL (SaÄŸdan Sola) modu ayarla
            if (currentLang === 'ar') {
                body.classList.add('rtl-mode');
                body.dir = 'rtl';
                document.getElementById('search-input').classList.remove('pl-10');
                document.getElementById('search-input').classList.add('pr-10');
                const searchIcon = document.querySelector('[data-lucide="search"]').parentElement;
                searchIcon.classList.remove('left-3');
                searchIcon.classList.add('right-3');
            } else {
                body.classList.remove('rtl-mode');
                body.dir = 'ltr';
                document.getElementById('search-input').classList.remove('pr-10');
                document.getElementById('search-input').classList.add('pl-10');
                const searchIcon = document.querySelector('[data-lucide="search"]').parentElement;
                searchIcon.classList.remove('right-3');
                searchIcon.classList.add('left-3');
            }

            // Mevcut gÃ¶rÃ¼nÃ¼mÃ¼ yeniden yÃ¼kle (iÃ§eriÄŸin gÃ¼ncellenmesi iÃ§in)
            viewChange(currentView, document.querySelector(`.nav-btn.text-primary`));

            // Lucide ikonlarÄ±nÄ± yeniden oluÅŸtur
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // EÄŸer gÃ¶rsel alÄ±ÅŸveriÅŸ modalÄ± aÃ§Ä±ksa, onu da yenile
            if (document.getElementById('visual-product-selector')) {
                updateShoppingModalTitles();
            }
        };

        // KullanÄ±cÄ± tipi gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¼ncelle
        function updateUserTypeDisplay() {
            const userTypeDisplay = document.getElementById('user-type-display');
            if (userTypeDisplay) {
                userTypeDisplay.textContent = currentUserInfo.role === 'volunteer'
                    ? getTranslation('volunteer_status')
                    : getTranslation('helper_status');
            }

            // GÃ¶nÃ¼llÃ¼ ise "GÃ¶revler" butonunu gÃ¶ster
            if (tasksNavBtn) {
                if (currentUserInfo.role === 'volunteer') {
                    tasksNavBtn.classList.remove('hidden');
                } else {
                    tasksNavBtn.classList.add('hidden');
                }
            }
        }

        window.changeLanguage = (newLang) => {
            currentLang = newLang;
            localStorage.setItem(LANGUAGE_KEY, newLang);
            applyLocalization();
        };

        // --- ERÄ°ÅÄ°LEBÄ°LÄ°RLÄ°K MANTIKLARI ---
        const applyAccessibilityStyles = () => {
            const rootElement = document.documentElement;
            rootElement.style.fontSize = (16 * currentFontSize) + 'px';
            localStorage.setItem(FONT_SIZE_KEY, currentFontSize.toString());

            if (isContrastMode) {
                body.classList.add('high-contrast');
            } else {
                body.classList.remove('high-contrast');
            }
            localStorage.setItem(CONTRAST_KEY, isContrastMode.toString());

            updateUserTypeDisplay();
        };

        window.toggleDarkMode = (isInit = false) => {
            const isDark = document.documentElement.classList.contains('dark');
            if (!isInit) {
                document.documentElement.classList.toggle('dark');
                const newTheme = isDark ? 'light' : 'dark';
                localStorage.setItem(THEME_KEY, newTheme);
            } else {
                const storedTheme = localStorage.getItem(THEME_KEY);
                if (storedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                }
            }
        };

        window.toggleContrastMode = () => {
            isContrastMode = !isContrastMode;
            applyAccessibilityStyles();
        };

        window.changeFontSize = (action) => {
            const rootElement = document.documentElement;
            let baseFontSize = 16;

            if (action === 'increase' && currentFontSize < 1.4) {
                currentFontSize += 0.1;
            } else if (action === 'decrease' && currentFontSize > 0.8) {
                currentFontSize -= 0.1;
            }

            currentFontSize = parseFloat(currentFontSize.toFixed(2));
            rootElement.style.fontSize = (baseFontSize * currentFontSize) + 'px';
            localStorage.setItem(FONT_SIZE_KEY, currentFontSize.toString());

            const sizeDisplay = document.getElementById('current-font-size-display');
            if (sizeDisplay) sizeDisplay.textContent = `${(currentFontSize * 100).toFixed(0)}%`;
        };

        // --- YENÄ°: GÃ–RSEL ÃœRÃœN SEÃ‡Ä°M SÄ°STEMÄ° FONKSÄ°YONLARI ---

        // ÃœrÃ¼n birimini Ã§eviriye gÃ¶re dÃ¶ndÃ¼r
        function getTranslatedUnit(unitKey) {
            const unitMap = {
                'kg': getTranslation('product_unit_kg'),
                'litre': getTranslation('product_unit_litre'),
                'adet': getTranslation('product_unit_piece'),
                'paket': getTranslation('product_unit_pack'),
                'dÃ¼zine': getTranslation('product_unit_dozen'),
                'ÅŸiÅŸe': getTranslation('product_unit_bottle'),
                'kutu': getTranslation('product_unit_box'),
                'torba': getTranslation('product_unit_bag')
            };
            return unitMap[unitKey] || unitKey;
        }

        // GÃ¶rsel alÄ±ÅŸveriÅŸ modalÄ±nÄ± aÃ§
        function openVisualShoppingModal() {
            selectedProducts = [];
            currentCategory = 'all';
            productSearchQuery = '';
            shoppingModalActiveTab = 'visual';

            if (voiceAssistantActive) {
                speakText('AlÄ±ÅŸveriÅŸ Listesi HazÄ±rlama. GÃ¶rsel Ã¼rÃ¼n seÃ§imi ile baÅŸlayabilirsiniz.');
            }
            let shoppingMode = 'browse';

            const modalContent = `
                <div class="shopping-modal-mobile md:shopping-modal-desktop bg-white dark:bg-gray-800 md:rounded-xl p-0 w-full md:w-11/12 md:max-w-4xl shadow-2xl h-full md:h-[90vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 p-4 border-b border-gray-200 dark:border-gray-700 z-10">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">${getTranslation('modal_shop_title')}</h2>
                            <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                                <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                            </button>
                        </div>
                        
                        <div class="flex mb-3 border-b border-gray-200 dark:border-gray-700">
                            <button onclick="switchShoppingTab('visual', this)" class="tab-btn flex-1 py-2 text-center font-semibold text-base rounded-t-lg ${shoppingModalActiveTab === 'visual' ? 'active text-white' : 'text-gray-500 dark:text-gray-400'}">
                                ${getTranslation('visual_shopping_title')}
                            </button>
                            <button onclick="switchShoppingTab('text', this)" class="tab-btn flex-1 py-2 text-center font-semibold text-base rounded-t-lg ${shoppingModalActiveTab === 'text' ? 'active text-white' : 'text-gray-500 dark:text-gray-400'}">
                                ${getTranslation('text_shopping_title')}
                            </button>
                        </div>
                        
                        <div class="relative">
                            <input type="text" id="product-search" placeholder="${getTranslation('search_products')}" 
                                   class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-primary focus:border-primary transition text-base text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500"
                                   onkeyup="filterProducts()">
                            <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div id="visual-shopping-panel" class="flex-1 overflow-hidden flex flex-col ${shoppingModalActiveTab === 'visual' ? '' : 'hidden'}">
                        <div class="overflow-x-auto px-4 py-3 category-scrollbar">
                            <div class="flex gap-2 min-w-max">
                                ${categories.map(cat => `
                                    <button onclick="selectCategory('${cat.id}', this)" 
                                            class="category-btn flex items-center px-3 py-2 rounded-lg text-sm font-semibold whitespace-nowrap ${currentCategory === cat.id ? 'active' : cat.color} ${currentCategory === cat.id ? '' : 'border border-gray-300 dark:border-gray-600'}">
                                        <span class="text-lg mr-1">${cat.emoji}</span>
                                        <span>${cat.name}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto px-4 pb-20">
                            <div id="products-grid" class="products-grid-mobile"></div>
                        </div>
                    </div>
                    
                    <div id="text-shopping-panel" class="flex-1 overflow-y-auto p-4 ${shoppingModalActiveTab === 'text' ? '' : 'hidden'}">
                        <input type="text" id="shop-item" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500 transition mb-3 text-base" placeholder="${getTranslation('shop_item_placeholder')}">
                        <textarea id="shop-list-details" rows="5" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500 transition text-base" placeholder="${getTranslation('request_details_placeholder')}"></textarea>
                        <div class="mt-3">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">${getTranslation('general_notes')}</label>
                            <textarea id="shopping-general-notes" rows="2" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm" placeholder="${getTranslation('general_notes_placeholder')}"></textarea>
                        </div>
                        <div id="modal-message" class="text-sm mt-2 hidden"></div>
                        <div class="flex gap-3 mt-4">
                            <button onclick="closeModal()" class="flex-1 px-4 py-3 text-base font-semibold text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                ${getTranslation('modal_cancel')}
                            </button>
                            <button onclick="submitShoppingRequest()" class="flex-1 px-4 py-3 text-base font-semibold text-white bg-primary rounded-lg hover:bg-indigo-600 transition">
                                ${getTranslation('modal_send')}
                            </button>
                        </div>
                    </div>
                    
                    <div id="bottom-cart-bar" class="bottom-cart-bar" onclick="openCartReview()" style="display: none;">
                        <div class="flex items-center justify-between text-white">
                            <div class="flex items-center">
                                <i data-lucide="shopping-cart" class="w-6 h-6 mr-2"></i>
                                <span class="font-semibold text-lg">Sepetim: <span id="cart-count-badge">0</span> ÃœrÃ¼n</span>
                            </div>
                            <button class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold transition">
                                Tamamla
                            </button>
                        </div>
                    </div>
                    
                    <div id="cart-review-drawer" class="cart-slide-drawer">
                        <div class="cart-slide-content p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">ğŸ›’ Sepetim</h3>
                                <button onclick="closeCartReview()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                                    <i data-lucide="x" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i>
                                </button>
                            </div>
                            <div id="cart-review-list" class="space-y-2 mb-4"></div>
                            <div class="mt-4">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">${getTranslation('general_notes')}</label>
                                <textarea id="shopping-general-notes" rows="2" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-emerald-500 focus:border-emerald-500 transition text-sm" placeholder="${getTranslation('general_notes_placeholder')}"></textarea>
                            </div>
                            <div id="modal-message" class="text-sm mt-2 hidden"></div>
                            <div class="flex gap-3 mt-4">
                                <button onclick="closeCartReview()" class="flex-1 px-4 py-3 text-base font-semibold text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                    ${getTranslation('modal_cancel')}
                                </button>
                                <button onclick="submitShoppingRequest()" class="flex-1 px-4 py-3 text-base font-semibold text-white bg-emerald-500 rounded-lg hover:bg-emerald-600 transition">
                                    ${getTranslation('modal_send')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');

            // ÃœrÃ¼nleri yÃ¼kle
            renderProducts();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Sekme deÄŸiÅŸtirme
        function switchShoppingTab(tabName, button) {
            shoppingModalActiveTab = tabName;

            // TÃ¼m sekmeleri gÃ¼ncelle
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-white');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            });

            // Aktif sekmeyi vurgula
            button.classList.add('active', 'text-white');
            button.classList.remove('text-gray-500', 'dark:text-gray-400');

            // Panelleri gÃ¶ster/gizle
            document.getElementById('visual-shopping-panel').classList.toggle('hidden', tabName !== 'visual');
            document.getElementById('text-shopping-panel').classList.toggle('hidden', tabName !== 'text');
        }

        // Kategori seÃ§imi
        function selectCategory(categoryId, button) {
            currentCategory = categoryId;

            // TÃ¼m kategori butonlarÄ±nÄ± gÃ¼ncelle
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active', 'text-white');
                const cat = categories.find(c => c.id === btn.getAttribute('onclick').match(/'([^']+)'/)[1]);
                if (cat && !btn.classList.contains('active')) {
                    btn.className = `category-btn flex items-center px-5 py-3 rounded-xl text-base font-semibold ${cat.color} border-2 border-gray-300 dark:border-gray-600`;
                }
            });

            // SeÃ§ili kategoriyi vurgula
            button.classList.add('active', 'text-white');
            button.classList.remove('border');

            // ÃœrÃ¼nleri filtrele
            filterProducts();

            if (voiceAssistantActive) {
                const selectedCategory = categories.find(c => c.id === categoryId);
                const filteredProducts = getFilteredProducts();
                const productNames = filteredProducts.slice(0, 5).map(p => p.name).join(', ');
                const moreCount = filteredProducts.length > 5 ? ` ve ${filteredProducts.length - 5} Ã¼rÃ¼n daha` : '';
                speakText(`${selectedCategory.name} seÃ§ildi. Listelenen Ã¼rÃ¼nler: ${productNames}${moreCount}.`);
            }
        }

        // ÃœrÃ¼nleri render et
        function renderProducts() {
            const productsGrid = document.getElementById('products-grid');
            if (!productsGrid) return;

            // FiltrelenmiÅŸ Ã¼rÃ¼nleri al
            const filteredProducts = getFilteredProducts();

            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-400 dark:text-gray-500">
                        <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-3"></i>
                        <p class="text-lg">${getTranslation('no_results')}</p>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = filteredProducts.map(product => {
                const isSelected = selectedProducts.some(p => p.id === product.id);
                const cleanName = product.name.replace(/kg/gi, 'Kilogram');
                return `
                    <div onclick="if(voiceAssistantActive){speakText('${cleanName}');}toggleProductSelection('${product.id}')" 
                         class="product-card flex flex-col items-center justify-center p-3 border-2 rounded-xl ${isSelected ? 'selected border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20' : 'border-gray-200 dark:border-gray-600'} bg-white dark:bg-gray-700 hover:shadow-lg">
                        <div class="text-3xl mb-2">${product.emoji}</div>
                        <div class="text-sm font-semibold text-gray-800 dark:text-gray-100 text-center">${product.name}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${getTranslatedUnit(product.defaultUnit)}</div>
                    </div>
                `;
            }).join('');

            // Update bottom cart bar
            updateBottomCartBar();
        }

        // ÃœrÃ¼nleri filtrele
        function filterProducts() {
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                productSearchQuery = searchInput.value.toLowerCase().trim();
            }
            renderProducts();
        }

        // FiltrelenmiÅŸ Ã¼rÃ¼nleri al
        function getFilteredProducts() {
            let filtered = productDatabase;

            // Kategoriye gÃ¶re filtrele
            if (currentCategory !== 'all') {
                filtered = filtered.filter(product => product.category === currentCategory);
            }

            // Arama sorgusuna gÃ¶re filtrele
            if (productSearchQuery) {
                filtered = filtered.filter(product =>
                    product.name.toLowerCase().includes(productSearchQuery) ||
                    product.keywords.some(keyword => keyword.toLowerCase().includes(productSearchQuery))
                );
            }

            return filtered;
        }

        // ÃœrÃ¼n seÃ§imini deÄŸiÅŸtir
        function toggleProductSelection(productId) {
            const product = productDatabase.find(p => p.id === productId);
            if (!product) return;

            const index = selectedProducts.findIndex(p => p.id === productId);

            if (index === -1) {
                // ÃœrÃ¼nÃ¼ ekle
                selectedProducts.push({
                    ...product,
                    quantity: 1,
                    note: ''
                });
            } else {
                // ÃœrÃ¼nÃ¼ Ã§Ä±kar
                selectedProducts.splice(index, 1);
            }

            // UI'Ä± gÃ¼ncelle
            renderProducts();
        }

        // SeÃ§ilen Ã¼rÃ¼nler listesini gÃ¼ncelle
        function updateSelectedProductsList() {
            const selectedList = document.getElementById('selected-products-list');
            const selectedCount = document.getElementById('selected-count');

            if (!selectedList || !selectedCount) return;

            selectedCount.textContent = selectedProducts.length;

            if (selectedProducts.length === 0) {
                selectedList.innerHTML = `
                    <div class="text-center py-12 text-gray-400 dark:text-gray-500">
                        <i data-lucide="shopping-cart" class="w-16 h-16 mx-auto mb-3"></i>
                        <p class="text-lg">${getTranslation('no_products_selected')}</p>
                    </div>
                `;
                return;
            }

            selectedList.innerHTML = selectedProducts.map((product, index) => `
                <div class="selected-item-row bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-2 border border-gray-200 dark:border-gray-600">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">${product.emoji}</span>
                            <div>
                                <div class="font-medium text-sm text-gray-800 dark:text-gray-100">${product.name}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${getTranslatedUnit(product.defaultUnit)}</div>
                            </div>
                        </div>
                        <button onclick="removeSelectedProduct(${index})" class="text-red-500 hover:text-red-700 transition">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center">
                            <button onclick="updateProductQuantity(${index}, -1)" class="qty-btn-large w-12 h-12 flex items-center justify-center bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 rounded-l-lg border-2 border-red-300 dark:border-red-700">
                                <span class="text-2xl font-bold">âˆ’</span>
                            </button>
                            <input type="number" min="1" value="${product.quantity}" 
                                   onchange="updateProductQuantityInput(${index}, this.value)"
                                   class="w-16 h-12 text-center border-y-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 text-xl font-bold">
                            <button onclick="updateProductQuantity(${index}, 1)" class="qty-btn-large w-12 h-12 flex items-center justify-center bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-800 rounded-r-lg border-2 border-green-300 dark:border-green-700">
                                <span class="text-2xl font-bold">+</span>
                            </button>
                        </div>
                        
                        <button onclick="toggleProductNote(${index})" class="text-xs text-primary hover:text-indigo-600 transition">
                            ${product.note ? '<i data-lucide="edit" class="w-3 h-3 mr-1"></i>' : '<i data-lucide="plus-circle" class="w-3 h-3 mr-1"></i>'}
                            ${product.note ? getTranslation('note') : getTranslation('add_note')}
                        </button>
                    </div>
                    
                    ${product.note ? `
                        <div class="mt-2 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-600">
                            ${product.note}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // ÃœrÃ¼n miktarÄ±nÄ± gÃ¼ncelle
        function updateProductQuantity(index, change) {
            if (selectedProducts[index]) {
                const newQuantity = selectedProducts[index].quantity + change;
                if (newQuantity >= 1) {
                    selectedProducts[index].quantity = newQuantity;
                    updateSelectedProductsList();
                }
            }
        }

        // ÃœrÃ¼n miktarÄ±nÄ± input'tan gÃ¼ncelle
        function updateProductQuantityInput(index, value) {
            if (selectedProducts[index]) {
                const newQuantity = parseInt(value) || 1;
                if (newQuantity >= 1) {
                    selectedProducts[index].quantity = newQuantity;
                    updateSelectedProductsList();
                }
            }
        }

        // ÃœrÃ¼n notunu aÃ§/kapat
        function toggleProductNote(index) {
            if (selectedProducts[index]) {
                const currentNote = selectedProducts[index].note;
                const newNote = prompt(getTranslation('note') + ':', currentNote || '');
                if (newNote !== null) {
                    selectedProducts[index].note = newNote.trim();
                    updateSelectedProductsList();
                }
            }
        }

        // SeÃ§ilen Ã¼rÃ¼nÃ¼ kaldÄ±r
        function removeSelectedProduct(index) {
            if (selectedProducts[index]) {
                selectedProducts.splice(index, 1);
                renderProducts(); // ÃœrÃ¼n grid'ini de gÃ¼ncelle
            }
        }

        // SeÃ§imi temizle
        function clearSelection() {
            selectedProducts = [];
            renderProducts();
        }

        // SeÃ§ilenleri alÄ±ÅŸveriÅŸ listesine ekle
        function addSelectedToShoppingList() {
            if (selectedProducts.length === 0) {
                showMessage(getTranslation('no_products_selected'), 'red');
                return;
            }

            // Metin giriÅŸine ekle
            const itemsText = selectedProducts.map(p =>
                `${p.emoji} ${p.name} (${p.quantity} ${getTranslatedUnit(p.defaultUnit)})${p.note ? ` - ${p.note}` : ''}`
            ).join(', ');

            const textInput = document.getElementById('shop-item');
            if (textInput) {
                const currentValue = textInput.value.trim();
                textInput.value = currentValue ? `${currentValue}, ${itemsText}` : itemsText;
            }

            // Metin sekmesine geÃ§
            const textTabBtn = document.querySelector('.tab-btn:nth-child(2)');
            if (textTabBtn) {
                switchShoppingTab('text', textTabBtn);
            }

            showMessage(`${selectedProducts.length} ${getTranslation('items')} ${getTranslation('add_selected_to_list').toLowerCase()}`, 'green');
        }

        // Update bottom cart bar
        function updateBottomCartBar() {
            const cartBar = document.getElementById('bottom-cart-bar');
            const cartBadge = document.getElementById('cart-count-badge');

            if (!cartBar || !cartBadge) return;

            cartBadge.textContent = selectedProducts.length;

            if (selectedProducts.length > 0) {
                cartBar.style.display = 'block';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } else {
                cartBar.style.display = 'none';
            }
        }

        // Open cart review drawer
        function openCartReview() {
            const drawer = document.getElementById('cart-review-drawer');
            const cartList = document.getElementById('cart-review-list');

            if (!drawer || !cartList) return;

            // Populate cart review list
            cartList.innerHTML = selectedProducts.map((product, index) => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${product.emoji}</span>
                            <div>
                                <div class="font-medium text-base text-gray-800 dark:text-gray-100">${product.name}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${product.quantity} ${getTranslatedUnit(product.defaultUnit)}</div>
                            </div>
                        </div>
                        <button onclick="removeSelectedProductFromReview(${index})" class="text-red-500 hover:text-red-700 transition">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    ${product.note ? `
                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-600">
                            ${product.note}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            drawer.classList.add('open');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Close cart review drawer
        function closeCartReview() {
            const drawer = document.getElementById('cart-review-drawer');
            if (drawer) {
                drawer.classList.remove('open');
            }
        }

        // Remove product from review
        function removeSelectedProductFromReview(index) {
            if (selectedProducts[index]) {
                selectedProducts.splice(index, 1);
                if (selectedProducts.length === 0) {
                    closeCartReview();
                } else {
                    openCartReview();
                }
                renderProducts();
            }
        }


        // AlÄ±ÅŸveriÅŸ modal baÅŸlÄ±klarÄ±nÄ± gÃ¼ncelle
        function updateShoppingModalTitles() {
            const visualTitle = document.querySelector('.tab-btn:first-child');
            const textTitle = document.querySelector('.tab-btn:nth-child(2)');
            const searchPlaceholder = document.getElementById('product-search');
            const categoriesTitle = document.querySelector('#visual-shopping-panel h3:nth-of-type(1)');
            const shoppingListTitle = document.querySelector('#visual-shopping-panel h3:nth-of-type(2)');
            const selectedItemsTitle = document.querySelector('#visual-shopping-panel .w-2\\/5 h3');

            if (visualTitle) visualTitle.textContent = getTranslation('visual_shopping_title');
            if (textTitle) textTitle.textContent = getTranslation('text_shopping_title');
            if (searchPlaceholder) searchPlaceholder.placeholder = getTranslation('search_products');
            if (categoriesTitle) categoriesTitle.textContent = getTranslation('categories');
            if (shoppingListTitle) shoppingListTitle.textContent = getTranslation('shopping_list');
            if (selectedItemsTitle) selectedItemsTitle.textContent = getTranslation('selected_items');
        }

        // AlÄ±ÅŸveriÅŸ isteÄŸini gÃ¶nder
        function submitShoppingRequest() {
            let details = {};
            let isFormValid = true;

            if (shoppingModalActiveTab === 'visual') {
                // GÃ¶rsel sekmeden gelen veriler
                if (selectedProducts.length === 0) {
                    showMessage('En az bir Ã¼rÃ¼n seÃ§melisiniz.', 'red');
                    return;
                }

                const generalNotes = document.getElementById('shopping-general-notes')?.value.trim() || '';

                details = {
                    items: selectedProducts.map(p => ({
                        id: p.id,
                        name: p.name,
                        emoji: p.emoji,
                        quantity: p.quantity,
                        unit: p.defaultUnit,
                        note: p.note
                    })),
                    notes: generalNotes,
                    type: 'visual_shopping'
                };

                detailsString = JSON.stringify(details);
            } else {
                // Metin sekmesinden gelen veriler (eski sistem)
                details.itemName = document.getElementById('shop-item')?.value.trim() || '';
                details.notes = document.getElementById('shop-list-details')?.value.trim() || '';

                if (!details.itemName) {
                    showMessage('En az bir Ã¶ÄŸe giriniz.', 'red');
                    return;
                }

                detailsString = JSON.stringify(details);
            }

            try {
                const requestData = {
                    id: Date.now().toString(),
                    type: 'shopping',
                    details: detailsString,
                    userId: 'local-user',
                    status: getTranslation('status_pending'),
                    timestamp: Date.now()
                };

                const requests = getRequests();
                requests.push(requestData);
                saveRequests(requests);

                showMessage('AlÄ±ÅŸveriÅŸ listeniz baÅŸarÄ±yla gÃ¶nderildi!', 'green');
                setTimeout(closeModal, 1500);

            } catch (error) {
                console.error("Ä°stek kaydederken hata oluÅŸtu:", error);
                showMessage('GÃ¶nderim hatasÄ±. LÃ¼tfen tekrar deneyin.', 'red');
            }
        }

        // --- LOCAL STORAGE (CRUD) MANTIKLARI ---
        function getRequests() {
            const json = localStorage.getItem(REQUESTS_KEY);
            let requests;
            try {
                requests = json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("Local Storage Requests parse hatasÄ±:", e);
                requests = [];
            }
            // Tarihe gÃ¶re sÄ±rala
            requests.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            return requests;
        }

        function saveRequests(requests) {
            localStorage.setItem(REQUESTS_KEY, JSON.stringify(requests));
            // Ana sayfayÄ± ve istekler sayfasÄ±nÄ± gÃ¼ncelle
            renderRequests(getRequests());
        }

        function saveVolunteerTasks(tasks) {
            localStorage.setItem(VOLUNTEER_TASKS_KEY, JSON.stringify(tasks));
        }

        // --- EKSTRA: GÃ–NÃœLLÃœ GÃ–REVLERÄ° SÄ°STEMÄ° ---

        // Rastgele gÃ¶rev oluÅŸtur
        function generateRandomTask() {
            const randomItemIndex = Math.floor(Math.random() * shoppingItems.length);
            const randomElderIndex = Math.floor(Math.random() * elderlyNames.length);
            const randomTime = Math.floor(Math.random() * 15) + 10; // 10-25 dakika

            const task = {
                id: 'TASK_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                items: shoppingItems[randomItemIndex][0],
                address: shoppingItems[randomItemIndex][1],
                elder: elderlyNames[randomElderIndex],
                time: randomTime + ' dakika',
                timestamp: Date.now(),
                status: 'pending'
            };

            volunteerTasks.push(task);
            saveVolunteerTasks(volunteerTasks);

            // EÄŸer gÃ¶revler sayfasÄ± aÃ§Ä±ksa, gÃ¶revi gÃ¶ster
            if (currentView === 'tasks') {
                renderVolunteerTasks();
            }

            return task;
        }

        // GÃ¶revleri gÃ¶ster
        function renderVolunteerTasks() {
            const taskList = document.getElementById('tasks-list');
            if (!taskList) return;

            taskList.innerHTML = '';

            if (volunteerTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="text-center p-6 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                        <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto text-gray-400 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 mb-2">${getTranslation('no_tasks')}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500">Yeni gÃ¶revler her 2-3 dakikada bir otomatik olarak eklenecek</p>
                    </div>
                `;
                return;
            }

            // Sadece bekleyen gÃ¶revleri gÃ¶ster
            const pendingTasks = volunteerTasks.filter(task => task.status === 'pending');

            if (pendingTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="text-center p-6 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
                        <i data-lucide="check-circle" class="w-12 h-12 mx-auto text-green-500 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 mb-2">TÃ¼m gÃ¶revler tamamlandÄ±!</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500">Yeni gÃ¶revler her 2-3 dakikada bir otomatik olarak eklenecek</p>
                    </div>
                `;
                return;
            }

            // GÃ¶revleri ters kronolojik sÄ±rayla gÃ¶ster
            const allActiveTasks = volunteerTasks.filter(task => task.status === 'pending' || task.status === 'accepted');
            allActiveTasks.sort((a, b) => b.timestamp - a.timestamp);

            allActiveTasks.forEach(task => {
                const taskTemplate = document.getElementById('task-template');
                const taskElement = taskTemplate.content.cloneNode(true);

                taskElement.querySelector('#task-items').textContent = `${getTranslation('task_items')}: ${task.items}`;
                taskElement.querySelector('#task-address').textContent = `${getTranslation('task_address')}: ${task.address}`;
                taskElement.querySelector('#task-time').textContent = `${getTranslation('task_time')}: ${task.time}`;
                taskElement.querySelector('#task-user').textContent = `${getTranslation('task_elder')}: ${task.elder}`;
                taskElement.querySelector('#task-id').textContent = task.id.substring(0, 8);

                const buttonContainer = taskElement.querySelector('.flex.justify-between.items-center');
                const actionButton = buttonContainer.querySelector('button');

                if (task.status === 'pending') {
                    actionButton.setAttribute('data-task-id', task.id);
                    actionButton.setAttribute('onclick', 'acceptTask(this)');
                } else if (task.status === 'accepted') {
                    const statusBadge = taskElement.querySelector('span');
                    statusBadge.textContent = 'Kabul Edildi';
                    statusBadge.className = 'text-xs font-semibold py-1 px-3 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 ml-3 flex-shrink-0';

                    actionButton.innerHTML = '<i data-lucide="package-check" class="w-4 h-4 mr-1"></i> âœ… GÃ¶revi Teslim Et';
                    actionButton.className = 'px-4 py-2 text-sm font-medium text-white bg-purple-500 rounded-lg hover:bg-purple-600 transition flex items-center';
                    actionButton.setAttribute('data-task-id', task.id);
                    actionButton.setAttribute('onclick', 'completeVolunteerTask(this)');
                }

                taskList.appendChild(taskElement);
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // GÃ¶revi kabul et
        window.acceptTask = function (button) {
            const taskId = button.getAttribute('data-task-id');
            const taskIndex = volunteerTasks.findIndex(task => task.id === taskId);

            if (taskIndex !== -1) {
                volunteerTasks[taskIndex].status = 'accepted';
                volunteerTasks[taskIndex].acceptedBy = 'Anonim KullanÄ±cÄ±';
                volunteerTasks[taskIndex].acceptedAt = Date.now();
                volunteerTasks[taskIndex].requestId = 'REQ_' + Date.now();

                saveVolunteerTasks(volunteerTasks);

                const requestData = {
                    id: volunteerTasks[taskIndex].requestId,
                    type: 'accepted_task',
                    details: JSON.stringify({
                        items: volunteerTasks[taskIndex].items,
                        address: volunteerTasks[taskIndex].address,
                        elder: volunteerTasks[taskIndex].elder,
                        taskId: taskId
                    }),
                    userId: 'local-user',
                    status: 'Kabul Edildi',
                    timestamp: Date.now(),
                    volunteerId: 'local-volunteer'
                };

                const requests = getRequests();
                requests.push(requestData);
                saveRequests(requests);

                button.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 mr-1"></i> Kabul Edildi';
                button.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                button.classList.add('bg-blue-500', 'cursor-default');
                button.disabled = true;

                const taskCard = button.closest('.task-card');
                const statusBadge = taskCard.querySelector('span');
                statusBadge.textContent = 'Kabul Edildi';
                statusBadge.className = 'text-xs font-semibold py-1 px-3 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 ml-3 flex-shrink-0';

                showCelebrationModal(volunteerTasks[taskIndex].elder);

                setTimeout(() => {
                    renderVolunteerTasks();
                }, 2000);
            }
        };

        window.completeVolunteerTask = function (button) {
            const taskId = button.getAttribute('data-task-id');
            const taskIndex = volunteerTasks.findIndex(task => task.id === taskId);

            if (taskIndex !== -1) {
                volunteerTasks[taskIndex].status = 'completed';
                volunteerTasks[taskIndex].completedAt = Date.now();
                saveVolunteerTasks(volunteerTasks);

                const requestId = volunteerTasks[taskIndex].requestId;
                if (requestId) {
                    const requests = getRequests();
                    const reqIndex = requests.findIndex(req => req.id === requestId);
                    if (reqIndex !== -1) {
                        requests[reqIndex].status = 'TamamlandÄ±';
                        saveRequests(requests);
                    }
                }

                button.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-1"></i> Teslim Edildi';
                button.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                button.classList.add('bg-green-600', 'cursor-default');
                button.disabled = true;

                const taskCard = button.closest('.task-card');
                taskCard.style.opacity = '0.7';

                showMessage('GÃ¶rev tamamlandÄ±! YaÅŸlÄ±mÄ±z Ã¶deme yapabilir.', 'green');

                setTimeout(() => {
                    taskCard.style.opacity = '0';
                    taskCard.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        taskCard.remove();
                        // EÄŸer gÃ¶rev kalmadÄ±ysa mesaj gÃ¶ster
                        const pendingTasks = volunteerTasks.filter(task => task.status === 'pending');
                        if (pendingTasks.length === 0) {
                            renderVolunteerTasks();
                        }
                    }, 300);
                }, 2000);
            }
        };

        // GÃ¶rev ekleme zamanlayÄ±cÄ±sÄ±nÄ± baÅŸlat
        function startTaskGenerator() {
            if (taskInterval) {
                clearInterval(taskInterval);
            }

            // Ä°lk gÃ¶revi 5 saniye sonra ekle (kullanÄ±cÄ±ya zaman tanÄ±)
            setTimeout(() => {
                if (currentUserInfo.role === 'volunteer') {
                    generateRandomTask();
                    console.log('Ä°lk gÃ¶rev eklendi:', new Date().toLocaleTimeString());

                    // EÄŸer gÃ¶revler sayfasÄ±nda ise, slide-in animasyon ile gÃ¶ster
                    if (currentView === 'tasks') {
                        const tasksList = document.getElementById('tasks-list');
                        if (tasksList && tasksList.children.length > 0) {
                            const firstTask = tasksList.querySelector('.task-card');
                            if (firstTask) {
                                firstTask.classList.add('slide-in-right');
                            }
                        }
                    }
                }
            }, 5000);

            // Her 30-60 saniyede bir rastgele gÃ¶rev ekle (demo iÃ§in hÄ±zlandÄ±rÄ±ldÄ±)
            taskInterval = setInterval(() => {
                if (currentUserInfo.role === 'volunteer') {
                    generateRandomTask();
                    console.log('Yeni gÃ¶rev eklendi:', new Date().toLocaleTimeString());
                }
            }, Math.random() * 30000 + 30000); // 30-60 saniye (demo iÃ§in)
        }

        let speechRecognition = null;
        let isListening = false;

        window.handleQuickAction = (type) => {
            const lang = currentLang;
            let titleKey, detailsPlaceholderKey, inputHtml = '', buttonTextKey = 'modal_send';

            switch (type) {
                case 'request':
                    titleKey = 'modal_req_title'; detailsPlaceholderKey = 'request_details_placeholder';
                    inputHtml = `
                        <div class="relative">
                            <textarea id="request-details" rows="4" class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-primary focus:border-primary transition" placeholder="${getTranslation(detailsPlaceholderKey)}"></textarea>
                            <button type="button" onclick="toggleVoiceDictation()" id="voice-dictation-btn" class="absolute bottom-3 right-3 p-2 rounded-lg bg-primary hover:bg-indigo-600 text-white transition" title="Sesle Yaz">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="dictation-status" class="text-xs text-gray-500 mt-1 hidden"></div>
                    `;
                    break;
                case 'medication':
                    titleKey = 'modal_med_title';
                    inputHtml = `
                        <input type="text" id="med-name" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-secondary focus:border-secondary transition mb-3" placeholder="${getTranslation('med_name_placeholder')}">
                        <input type="time" id="med-time" value="09:00" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-secondary focus:border-secondary transition">
                    `;
                    break;
                case 'shopping':
                    // YENÄ°: GÃ¶rsel alÄ±ÅŸveriÅŸ modalÄ±nÄ± aÃ§
                    openVisualShoppingModal();
                    return; // Normal modal aÃ§ma iÅŸlemini durdur
                    break;
                case 'volunteer':
                    titleKey = 'modal_volunteer_title'; buttonTextKey = 'modal_save';
                    inputHtml = `
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">${getTranslation('volunteer_desc')}</p>
                        <textarea id="volunteer-notes" rows="4" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition" placeholder="${getTranslation('volunteer_placeholder')}"></textarea>
                    `;
                    break;
                default:
                    return;
            }

            const modalContent = `
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-100">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">${getTranslation(titleKey)}</h2>
                    ${inputHtml}
                    <div id="modal-message" class="text-sm text-red-500 mt-2 hidden"></div>
                    <div class="flex justify-end space-x-3 mt-5">
                        <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition">${getTranslation('modal_cancel')}</button>
                        <button id="modal-action-btn" onclick="submitRequest('${type}')" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-full hover:bg-indigo-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">${getTranslation(buttonTextKey)}</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.submitRequest = (type) => {
            let details = {};
            let detailsString = '';
            let isFormValid = true;

            try {
                switch (type) {
                    case 'request':
                        details.text = document.getElementById('request-details').value.trim();
                        if (details.text.length < 5) { isFormValid = false; showMessage('Detaylar en az 5 karakter olmalÄ±dÄ±r.', 'red'); }
                        break;
                    case 'medication':
                        details.itemName = document.getElementById('med-name').value.trim();
                        details.time = document.getElementById('med-time').value.trim();
                        if (!details.itemName || !details.time) { isFormValid = false; showMessage('Ä°laÃ§ adÄ± ve saat gereklidir.', 'red'); }
                        break;
                    case 'shopping':
                        // Bu artÄ±k submitShoppingRequest() tarafÄ±ndan yÃ¶netiliyor
                        break;
                    case 'volunteer':
                        details.notes = document.getElementById('volunteer-notes').value.trim();
                        if (details.notes.length < 10) { isFormValid = false; showMessage('LÃ¼tfen kendinizden daha detaylÄ± bahsedin (en az 10 karakter).', 'red'); }
                        break;
                    default:
                        return;
                }

                if (!isFormValid) return;

                if (type !== 'shopping') {
                    detailsString = JSON.stringify(details);
                }

                const requestData = {
                    id: Date.now().toString(), // Benzersiz ID
                    type: type,
                    details: detailsString,
                    userId: 'local-user',
                    status: type === 'volunteer' ? getTranslation('status_applied') : getTranslation('status_pending'),
                    timestamp: Date.now()
                };

                const requests = getRequests();
                requests.push(requestData);
                saveRequests(requests);

                showMessage('BaÅŸarÄ±yla gÃ¶nderildi!', 'green');

                // EÄŸer gÃ¶nÃ¼llÃ¼ baÅŸvurusu ise 30-60 saniye sonra bildirim gÃ¶ster
                if (type === 'volunteer') {
                    setTimeout(() => {
                        // KullanÄ±cÄ±yÄ± gÃ¶nÃ¼llÃ¼ yap
                        currentUserInfo.role = 'volunteer';
                        localStorage.setItem(USER_INFO_KEY, JSON.stringify(currentUserInfo));

                        // GÃ¶rev Ã¼reticisini baÅŸlat
                        startTaskGenerator();

                        // Bildirim gÃ¶ster
                        showVolunteerNotification();

                        // KullanÄ±cÄ± bilgilerini gÃ¼ncelle
                        applyAccessibilityStyles();

                        // GÃ¶revler sayfasÄ±nÄ± gÃ¶ster
                        if (currentView === 'home') {
                            const tasksButton = document.getElementById('tasks-nav-btn');
                            if (tasksButton) {
                                viewChange('tasks', tasksButton);
                            }
                        }

                        // Hesap sayfasÄ±nÄ± yenile
                        if (currentView === 'account') {
                            renderAccount();
                        }
                    }, Math.random() * 30000 + 30000); // 30-60 saniye arasÄ±
                }

                setTimeout(closeModal, 1500);

            } catch (error) {
                console.error("Ä°stek kaydederken hata oluÅŸtu:", error);
                showMessage('GÃ¶nderim hatasÄ±. LÃ¼tfen tekrar deneyin.', 'red');
            }
        };

        // GÃ¶nÃ¼llÃ¼ bildirimi gÃ¶ster
        function showVolunteerNotification() {
            // Bildirim ikonuna animasyon ekle
            const bellIcon = document.querySelector('[data-lucide="bell"]');
            if (bellIcon) {
                bellIcon.parentElement.classList.add('animate-pulse');
                bellIcon.parentElement.classList.add('bg-green-100', 'dark:bg-green-900');
            }

            // KullanÄ±cÄ±ya bilgi ver
            alert(getTranslation('volunteer_approved'));

            // 5 saniye sonra animasyonu kaldÄ±r
            setTimeout(() => {
                if (bellIcon) {
                    bellIcon.parentElement.classList.remove('animate-pulse');
                    bellIcon.parentElement.classList.remove('bg-green-100', 'dark:bg-green-900');
                }
            }, 5000);
        }

        // --- GÃ–RÃœNÃœM VE RENDER MANTIKLARI ---

        window.viewChange = (viewName, buttonElement) => {
            currentView = viewName;

            navButtons.forEach(btn => {
                btn.classList.remove('text-primary');
                btn.classList.add('text-gray-400', 'hover:text-primary');
                btn.querySelector('span').classList.remove('font-medium');
                if (btn === buttonElement) {
                    btn.classList.add('text-primary');
                    btn.classList.remove('text-gray-400', 'hover:text-primary');
                    btn.querySelector('span').classList.add('font-medium');
                }
            });

            switch (viewName) {
                case 'home':
                    renderHome();
                    if (voiceAssistantActive) {
                        speakText('Ana Sayfa. HÄ±zlÄ± iÅŸlemler ve son istekler burada.');
                    }
                    break;
                case 'tasks':
                    renderTasksPage();
                    if (voiceAssistantActive) {
                        const pendingCount = volunteerTasks.filter(t => t.status === 'pending').length;
                        speakText(`GÃ¶revler SayfasÄ±. ${pendingCount} bekleyen gÃ¶rev var.`);
                    }
                    break;
                case 'requests':
                    renderRequestsPage();
                    if (voiceAssistantActive) {
                        const requestsCount = getRequests().length;
                        speakText(`Ä°steklerim SayfasÄ±. Toplam ${requestsCount} istek kaydÄ± var.`);
                    }
                    break;
                case 'account':
                    renderAccount();
                    break;
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Ana Sayfa Render
        function renderHome() {
            if (currentUserInfo.role === 'volunteer') {
                pageContent.innerHTML = `
                    <section class="mb-6">
                        <h2 class="text-xl font-bold mb-3 text-gray-800 dark:text-gray-100">GÃ¶nÃ¼llÃ¼ Panosu</h2>
                        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center mb-3">
                                <i data-lucide="heart-handshake" class="w-10 h-10 mr-3"></i>
                                <div>
                                    <h3 class="text-xl font-bold">HoÅŸ Geldiniz, GÃ¶nÃ¼llÃ¼mÃ¼z!</h3>
                                    <p class="text-sm opacity-90">YardÄ±ma ihtiyacÄ± olan yaÅŸlÄ±larÄ±mÄ±z sizi bekliyor</p>
                                </div>
                            </div>
                            <button onclick="viewChange('tasks', document.querySelector('.nav-btn:nth-child(2)'))" class="w-full mt-4 px-6 py-3 bg-white text-purple-600 rounded-lg font-bold hover:bg-gray-100 transition flex items-center justify-center">
                                <i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i>
                                Bekleyen GÃ¶revlere Git
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-700 text-center">
                                <p class="text-3xl font-bold text-green-600 dark:text-green-400">${volunteerTasks.filter(t => t.status === 'accepted' || t.status === 'completed').length}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">TamamladÄ±ÄŸÄ±nÄ±z GÃ¶revler</p>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-700 text-center">
                                <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">${volunteerTasks.filter(t => t.status === 'pending').length}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Bekleyen GÃ¶revler</p>
                            </div>
                        </div>
                    </section>
                `;
            } else {
                pageContent.innerHTML = `
                    <section class="mb-6">
                        <h2 class="text-xl font-bold mb-3 text-gray-800 dark:text-gray-100">HÄ±zlÄ± Ä°ÅŸlemler</h2>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button onclick="openEmergencyConfirmModal()" class="col-span-2 flex flex-col items-center justify-center p-5 bg-red-600 hover:bg-red-700 rounded-xl shadow-lg transition duration-150 border-2 border-red-700 animate-pulse">
                                <span class="text-4xl mb-2">ğŸš‘</span>
                                <span class="text-xl font-bold text-white text-center">112 ACÄ°L ARA</span>
                            </button>
                            <button onclick="handleQuickAction('medication')" class="flex flex-col items-center justify-center p-3 bg-secondary/10 hover:bg-secondary/20 rounded-xl transition duration-150 border border-secondary/20">
                                <i data-lucide="pill" class="w-6 h-6 text-secondary mb-1"></i>
                                <span class="text-sm font-medium text-secondary text-center mt-1" data-i18n="qa_medication">${getTranslation('qa_medication')}</span>
                            </button>
                            <button onclick="handleQuickAction('shopping')" class="flex flex-col items-center justify-center p-3 bg-emerald-500/10 hover:bg-emerald-500/20 rounded-xl transition duration-150 border border-emerald-500/20">
                                <i data-lucide="shopping-cart" class="w-6 h-6 text-emerald-500 mb-1"></i>
                                <span class="text-sm font-medium text-emerald-500 text-center mt-1" data-i18n="qa_shopping">${getTranslation('qa_shopping')}</span>
                            </button>
                             <button onclick="handleQuickAction('volunteer')" class="col-span-2 flex flex-col items-center justify-center p-3 bg-fuchsia-500/10 hover:bg-fuchsia-500/20 rounded-xl transition duration-150 border border-fuchsia-500/20">
                                <i data-lucide="user-check" class="w-6 h-6 text-fuchsia-500 mb-1"></i>
                                <span class="text-sm font-medium text-fuchsia-500 text-center mt-1" data-i18n="qa_volunteer">${getTranslation('qa_volunteer')}</span>
                            </button>
                        </div>
                    </section>

                    <section>
                        <h2 class="text-xl font-bold mb-3 text-gray-800 dark:text-gray-100" data-i18n="home_title">${getTranslation('home_title')}</h2>
                        <div id="requests-list" class="space-y-3">
                            <p class="text-center text-gray-500 dark:text-gray-400 p-4" data-i18n="loading_requests" id="loading-requests">${getTranslation('loading_requests')}</p>
                        </div>
                    </section>
                `;
                renderRequests(getRequests());
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // GÃ¶revler SayfasÄ± Render (Sadece GÃ¶nÃ¼llÃ¼ler Ä°Ã§in)
        function renderTasksPage() {
            if (currentUserInfo.role !== 'volunteer') {
                // EÄŸer gÃ¶nÃ¼llÃ¼ deÄŸilse ana sayfaya yÃ¶nlendir
                const homeButton = document.querySelector(`.nav-btn:first-child`);
                if (homeButton) viewChange('home', homeButton);
                return;
            }

            pageContent.innerHTML = `
                <div class="mb-4">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 dark:text-gray-100" data-i18n="tasks_title">${getTranslation('tasks_title')}</h2>
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg border border-blue-200 dark:border-blue-700 mb-4">
                        <p class="text-sm text-blue-800 dark:text-blue-300 flex items-center">
                            <i data-lucide="info" class="w-4 h-4 mr-2"></i>
                            <span data-i18n="tasks_info">${getTranslation('tasks_info')}</span>
                        </p>
                    </div>
                </div>
                
                <!-- Aktif GÃ¶revler -->
                <div id="tasks-list" class="space-y-3">
                    <!-- GÃ¶revler buraya eklenecek -->
                </div>
                
                <!-- Ä°statistikler -->
                <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3">GÃ¶rev Ä°statistikleri</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-emerald-500">${volunteerTasks.filter(t => t.status === 'accepted').length}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Tamamlanan GÃ¶rev</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-yellow-500">${volunteerTasks.filter(t => t.status === 'pending').length}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Bekleyen GÃ¶rev</p>
                        </div>
                    </div>
                </div>
            `;

            renderVolunteerTasks();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Ä°steklerim SayfasÄ± Render
        function renderRequestsPage() {
            pageContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100" data-i18n="requests_title">${getTranslation('requests_title')}</h2>
                <div class="bg-yellow-50 dark:bg-yellow-900/50 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700 mb-4">
                    <p class="text-sm text-yellow-800 dark:text-yellow-200 flex items-center"><i data-lucide="info" class="w-4 h-4 mr-2"></i> <span data-i18n="requests_info">${getTranslation('requests_info')}</span></p>
                </div>
                <div id="requests-list" class="space-y-3">
                    <p class="text-center text-gray-500 dark:text-gray-400 p-4" data-i18n="loading_requests" id="loading-requests">${getTranslation('loading_requests')}</p>
                </div>
            `;
            renderRequests(getRequests()); // Yerel istekleri yÃ¼kle
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function transliterate(text) {
            if (!text) return '';
            const map = {
                'ÅŸ': 's', 'Å': 'S',
                'ÄŸ': 'g', 'Ä': 'G',
                'Ã¼': 'u', 'Ãœ': 'U',
                'Ã¶': 'o', 'Ã–': 'O',
                'Ã§': 'c', 'Ã‡': 'C',
                'Ä°': 'I', 'Ä±': 'i'
            };
            return text.replace(/[ÅŸÅÄŸÄÃ¼ÃœÃ¶Ã–Ã§Ã‡Ä°Ä±]/g, match => map[match] || match);
        }

        window.downloadVolunteerReport = function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const completedTasks = volunteerTasks.filter(t => t.status === 'accepted').length;
            const totalHours = Math.floor(completedTasks * 0.5);
            const trustScore = (4.5 + (completedTasks * 0.1)).toFixed(1);
            const today = new Date().toLocaleDateString('tr-TR');

            const earnedBadges = badgeSystem.filter(b => completedTasks >= b.threshold);

            const motivationalQuotes = [
                transliterate("Yaptiginiz iyilikler dunyayi degistiriyor."),
                transliterate("Her kucuk yardim, buyuk bir umut olur."),
                transliterate("Insanlara dokunmak, hayata dokunmaktir."),
                transliterate("Gonullu olmak, insanliga hizmet etmektir.")
            ];
            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];

            const reviews = [
                transliterate("Cok kibar bir evladimiz, tesekkur ederim."),
                transliterate("Ilacimi hizlica yetistirdi, Allah razi olsun."),
                transliterate("Market alisverisimi uzun zamandir yapamiyordum. Cok yardimci oldu.")
            ];

            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(transliterate("BIR EL DE BIZDEN"), 105, 15, { align: 'center' });

            doc.setFontSize(18);
            doc.text(transliterate("GONULLU KARNESI"), 105, 28, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(transliterate("Gonullu Bilgileri:"), 20, 55);

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(transliterate("Ad Soyad: Anonim Gonullu"), 20, 65);
            doc.text(`Tarih: ${today}`, 20, 73);
            doc.text(`Guven Skoru: ${trustScore}/5.0`, 20, 81);

            doc.setFillColor(249, 115, 22);
            doc.roundedRect(15, 90, 180, 40, 3, 3, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(transliterate("ISTATISTIKLER"), 105, 102, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${totalHours} Saat`, 40, 113, { align: 'center' });
            doc.text(transliterate("Toplam Saat"), 40, 121, { align: 'center' });

            doc.text(`${completedTasks} Gorev`, 105, 113, { align: 'center' });
            doc.text(transliterate("Tamamlanan"), 105, 121, { align: 'center' });

            doc.text(`${earnedBadges.length} Rozet`, 170, 113, { align: 'center' });
            doc.text(transliterate("Kazanilan"), 170, 121, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(transliterate("Kazanilan Rozetler:"), 20, 145);

            let badgeY = 155;
            if (earnedBadges.length > 0) {
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                earnedBadges.forEach((badge, index) => {
                    doc.text(`â€¢ ${transliterate(badge.name)}`, 25, badgeY);
                    badgeY += 8;
                });
            } else {
                doc.setFontSize(11);
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(transliterate("Henuz rozet kazanilmadi."), 25, badgeY);
                doc.setTextColor(0, 0, 0);
            }

            const taskHistoryY = badgeY + 15;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(transliterate("Son Gorevler:"), 20, taskHistoryY);

            const recentTasks = volunteerTasks.filter(t => t.status === 'accepted').slice(-3);
            let taskY = taskHistoryY + 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            if (recentTasks.length > 0) {
                recentTasks.forEach(task => {
                    const taskTime = new Date(task.acceptedAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                    const taskText = `${taskTime} - ${transliterate(task.items.substring(0, 30))} - Tamamlandi`;
                    doc.text(taskText, 25, taskY);
                    taskY += 7;
                });
            } else {
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(transliterate("Henuz gorev tamamlanmadi."), 25, taskY);
                doc.setTextColor(0, 0, 0);
                taskY += 7;
            }

            const quoteY = taskY + 12;
            doc.setFillColor(240, 240, 240);
            doc.roundedRect(15, quoteY - 5, 180, 20, 2, 2, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'italic');
            doc.setTextColor(79, 70, 229);
            doc.text(`"${randomQuote}"`, 105, quoteY + 5, { align: 'center', maxWidth: 170 });

            doc.setTextColor(0, 0, 0);
            const reviewY = quoteY + 30;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(transliterate("Yasli Kullanicilardan Yorumlar:"), 20, reviewY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            let revY = reviewY + 10;
            const selectedReviews = reviews.slice(0, Math.min(2, reviews.length));
            selectedReviews.forEach(review => {
                doc.text(`- ${review}`, 25, revY);
                revY += 7;
            });

            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(transliterate("Bu belge Bir El de Bizden platformu tarafindan otomatik olusturulmustur."), 105, 285, { align: 'center' });

            doc.save(transliterate('Gonullu_Karnesi.pdf'));
        };

        function renderAccount() {
            const isVolunteer = currentUserInfo.role === 'volunteer';
            const roleText = isVolunteer ? getTranslation('account_role_volunteer') : getTranslation('account_role_helper');

            if (voiceAssistantActive) {
                const completedTasks = isVolunteer ? volunteerTasks.filter(t => t.status === 'accepted').length : 0;
                const statusText = isVolunteer ? `GÃ¶nÃ¼llÃ¼ olarak ${completedTasks} gÃ¶rev tamamladÄ±nÄ±z.` : 'Hizmet alan olarak kayÄ±tlÄ±sÄ±nÄ±z.';
                speakText(`Hesap SayfasÄ±. Merhaba Anonim KullanÄ±cÄ±. ${statusText}`);
            }

            pageContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100" data-i18n="account_title">${getTranslation('account_title')}</h2>
                
                <!-- KullanÄ±cÄ± Bilgileri -->
                <div class="bg-gradient-to-r from-primary/10 to-secondary/10 dark:from-primary/20 dark:to-secondary/20 p-4 rounded-xl mb-6">
                    <div class="flex items-center mb-3">
                        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center text-white text-2xl font-bold">
                            A
                        </div>
                        <div class="ml-4">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">Anonim KullanÄ±cÄ±</h3>
                            <p class="text-gray-600 dark:text-gray-300">${roleText}</p>
                        </div>
                    </div>
                    
                    ${isVolunteer ? `
                    <div class="mt-3 p-3 bg-green-100 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-700">
                        <p class="text-sm text-green-800 dark:text-green-300 flex items-center">
                            <i data-lucide="badge-check" class="w-4 h-4 mr-2"></i>
                            <span>âœ… ${getTranslation('volunteer_status')} olarak kayÄ±tlÄ±sÄ±nÄ±z. YardÄ±m etmeye hazÄ±rsÄ±nÄ±z!</span>
                        </p>
                    </div>
                    ` : `
                    <div class="mt-3 p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-700">
                        <p class="text-sm text-blue-800 dark:text-blue-300 flex items-center">
                            <i data-lucide="info" class="w-4 h-4 mr-2"></i>
                            <span>${getTranslation('helper_status')} olarak kayÄ±tlÄ±sÄ±nÄ±z. GÃ¶nÃ¼llÃ¼ olmak iÃ§in "HÄ±zlÄ± Ä°ÅŸlemler"den baÅŸvurabilirsiniz.</span>
                        </p>
                    </div>
                    `}
                </div>
                
                <!-- GÃ¼ven Skoru (Trust Score) -->
                ${isVolunteer ? `
                <div class="mb-6 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 dark:from-yellow-900/20 dark:to-amber-900/20 rounded-xl border border-yellow-200 dark:border-yellow-700">
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-2 flex items-center">
                        <span class="mr-2">â­</span> GÃ¼ven Skoru
                    </h3>
                    <div class="flex items-center justify-center space-x-1 text-3xl">
                        <span>â­</span><span>â­</span><span>â­</span><span>â­</span><span>â­</span>
                    </div>
                    <p class="text-center text-sm text-yellow-700 dark:text-yellow-300 mt-2">5/5 - MÃ¼kemmel GÃ¶nÃ¼llÃ¼!</p>
                </div>
                ` : ''}
                
                <!-- Ä°statistikler -->
                ${isVolunteer ? `
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <p class="text-2xl font-bold text-primary">${volunteerTasks.filter(t => t.status === 'accepted').length}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="stats_completed">${getTranslation('stats_completed')}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <p class="text-2xl font-bold text-secondary">${Math.floor(volunteerTasks.filter(t => t.status === 'accepted').length * 0.5)}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="stats_hours">${getTranslation('stats_hours')}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <p class="text-2xl font-bold text-emerald-500">${volunteerTasks.filter(t => t.status === 'pending').length}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="stats_pending">${getTranslation('stats_pending')}</p>
                    </div>
                </div>
                ` : ''}
                
                <!-- Dijital Rozetler (Gamification) -->
                ${isVolunteer ? `
                <div class="mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3 flex items-center">
                        <span class="mr-2">ğŸ–ï¸</span> Dijital Rozetlerim
                    </h3>
                    <div class="grid grid-cols-3 gap-3">
                        ${badgeSystem.map(badge => {
                const completedCount = volunteerTasks.filter(t => t.status === 'accepted').length;
                const isEarned = completedCount >= badge.threshold;
                return `
                                <div class="badge-card ${isEarned ? 'earned' : 'locked'} p-3 rounded-xl text-center border ${isEarned ? '' : 'border-gray-200 dark:border-gray-600'}">
                                    <div class="text-3xl mb-1">${badge.icon}</div>
                                    <p class="text-xs font-medium ${isEarned ? 'text-yellow-800' : 'text-gray-500 dark:text-gray-400'}">${badge.name}</p>
                                    ${!isEarned ? `<p class="text-xs text-gray-400 mt-1">${badge.threshold} gÃ¶rev</p>` : ''}
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${isVolunteer ? `
                <div class="mb-6">
                    <button onclick="downloadVolunteerReport()" class="w-full flex items-center justify-center p-4 bg-gradient-to-r from-primary to-secondary rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="mr-3">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span class="text-white font-bold text-lg">ğŸ“„ GÃ¶nÃ¼llÃ¼ Karnemi Ä°ndir</span>
                    </button>
                </div>
                ` : ''}
                
                <!-- Adres Bilgileri DÃ¼zenleme -->
                <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3 flex items-center">
                        <i data-lucide="map-pin" class="w-5 h-5 text-gray-500 dark:text-gray-400 mr-2"></i>
                        Adres Bilgilerim
                    </h3>
                    <div class="relative">
                        <textarea id="user-address" rows="3" class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:ring-primary focus:border-primary transition">${currentUserInfo.address || 'Adres bilgisi girilmemiÅŸ'}</textarea>
                        <button type="button" onclick="toggleAddressDictation()" id="address-voice-btn" class="absolute bottom-3 right-3 p-2 rounded-lg bg-primary hover:bg-indigo-600 text-white transition" title="Sesle Yaz">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="address-dictation-status" class="text-xs text-gray-500 mt-1 hidden"></div>
                    <button onclick="saveUserAddress()" class="w-full mt-3 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition">Kaydet</button>
                </div>
                
                <!-- MenÃ¼ SeÃ§enekleri -->
                <div class="space-y-2">
                    
                    <button class="w-full flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="help-circle" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                            <span class="text-gray-800 dark:text-gray-100" data-i18n="menu_support">${getTranslation('menu_support')}</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </button>
                    
                    <button onclick="handleLogout()" class="w-full flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="log-out" class="w-5 h-5 text-red-500"></i>
                            <span class="text-red-600 dark:text-red-400" data-i18n="menu_logout">${getTranslation('menu_logout')}</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-red-400"></i>
                    </button>
                </div>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderRequests(requests) {
            const listElement = document.getElementById('requests-list');
            if (!listElement) return;

            listElement.innerHTML = '';
            if (requests.length === 0) {
                listElement.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg" data-i18n="no_requests">${getTranslation('no_requests')}</p>`;
                return;
            }

            requests.forEach(req => {
                let statusColor = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300';
                if (req.status === 'TamamlandÄ±') {
                    statusColor = 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300';
                } else if (req.status === 'Ã–dendi') {
                    statusColor = 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300';
                } else if (req.status === getTranslation('status_complete')) {
                    statusColor = 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300';
                }

                let requestTitle = '';
                switch (req.type) {
                    case 'request': requestTitle = getTranslation('qa_request'); break;
                    case 'medication': requestTitle = getTranslation('qa_medication'); break;
                    case 'shopping': requestTitle = getTranslation('qa_shopping'); break;
                    case 'volunteer': requestTitle = getTranslation('qa_volunteer'); break;
                    case 'accepted_task': requestTitle = 'Kabul Edilen GÃ¶rev'; break;
                }

                let detailsObj = {};
                try { detailsObj = JSON.parse(req.details); } catch (e) { detailsObj.text = req.details || ''; }

                // GÃ¶rsel alÄ±ÅŸveriÅŸ iÃ§in Ã¶zel iÅŸleme
                let detailText = '';
                if (req.type === 'shopping' && detailsObj.type === 'visual_shopping') {
                    // GÃ¶rsel alÄ±ÅŸveriÅŸ listesini formatla
                    if (detailsObj.items && Array.isArray(detailsObj.items)) {
                        detailText = detailsObj.items.map(item =>
                            `${item.emoji} ${item.name} (${item.quantity} ${getTranslatedUnit(item.unit)})`
                        ).join(', ');
                        if (detailsObj.notes) {
                            detailText += ` - ${detailsObj.notes}`;
                        }
                    } else {
                        detailText = 'GÃ¶rsel alÄ±ÅŸveriÅŸ listesi';
                    }
                } else {
                    // Normal metin tabanlÄ± detaylar
                    detailText = detailsObj.text || detailsObj.itemName || (detailsObj.items ? `AlÄ±ÅŸveriÅŸ: ${detailsObj.items}` : 'Detay yok');
                }

                const isCompleted = req.status === 'TamamlandÄ±';
                const isPaid = req.status === 'Ã–dendi';

                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-700 p-4 rounded-xl shadow-lg border border-gray-200 dark:border-gray-600';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 truncate">${requestTitle}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-2">${detailText}</p>
                        </div>
                        <span class="text-xs font-semibold py-1 px-3 rounded-full ${statusColor} ml-3 flex-shrink-0">${req.status}</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 pt-2 border-t border-gray-100 dark:border-gray-600 mt-2">
                        <span data-i18n="sent_by">${getTranslation('sent_by')}: ${getTranslation('user_you')}</span>
                        <span data-i18n="date">${getTranslation('date')}: ${new Date(req.timestamp).toLocaleDateString(currentLang)}</span>
                    </div>

                    ${isCompleted && !isPaid ? `
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <button onclick="openPaymentModal('${req.id}')" class="w-full flex items-center justify-center p-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition transform hover:scale-105">
                                <span class="text-xl mr-2">ğŸ’³</span> Ã–deme Yap
                            </button>
                        </div>
                    ` : ''}

                    ${isPaid ? `
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-center p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-xl">
                                <span class="text-xl mr-2">âœ…</span> Ã–deme BaÅŸarÄ±lÄ±
                            </div>
                        </div>
                    ` : !isCompleted ? `
                        <div class="flex justify-end space-x-2 mt-3">
                            <button onclick="editRequest('${req.id}', '${req.type}', '${req.details.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')" class="text-sm text-primary hover:text-indigo-600 font-medium transition">${getTranslation('modal_save')}</button>
                            <button onclick="deleteRequest('${req.id}')" class="text-sm text-red-500 hover:text-red-600 font-medium transition">${getTranslation('modal_delete')}</button>
                        </div>
                    ` : ''}
                `;
                listElement.appendChild(card);
            });
        }

        window.openPaymentModal = function (requestId) {
            const requests = getRequests();
            const request = requests.find(req => req.id === requestId);

            if (!request) {
                console.error('Request not found');
                return;
            }

            let detailsObj = {};
            try { detailsObj = JSON.parse(request.details); } catch (e) { detailsObj = {}; }

            const volunteerName = detailsObj.elder || 'GÃ¶nÃ¼llÃ¼';

            const paymentModalHTML = `
                <div class="payment-modal" onclick="event.target === this && closePaymentModal()">
                    <div class="payment-modal-content">
                        <button onclick="closePaymentModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">
                            &times;
                        </button>

                        <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-2">GÃ¼venli Ã–deme</h2>
                        <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4">GÃ¶nÃ¼llÃ¼ye Ã¶deme yapÄ±n</p>

                        <div class="qr-code-container">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYQAAAF5CAYAAACfsV0UAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAuhSURBVHhe7dyxbhxVG8fh9XcD3AN1WgsKF7kGN1wIFdU6FU1SQ8kV2D1VJKgipaLnDugSIdH48/wzUppZ77zgNzkzeR7piF2JXc+cmfVPa+Wci/sHBwC+eP+b/wvAF04QAAhBACAEAYAQBACi9K+M3r59e/j111/nZ6z1ww8/zI/Ou7i4mB+dV/kHYiO876TzvdeqHMMIuuahU9cc//jjj/Mj1vruu+8OX3/99fzscaUg3N3dHa6vr+dnrNX1S3Br7zvpfO+1KscwAkH4aItz8bm9efPmcHl5OT97nD8ZARCCAEAIAgAhCACEIAAQggBACAIAIQgAhCAAEG0rlY/H4/xon168eDE/Os+qzX/HiuLtGuGe9zvog8pK5enCrXZ7eztd5VXj4WLMr9qnpXM+Nbos/aw9ja1ZOocvdXRZ+lmnxp5Nv1+XznlpPARhftV5/mQEQAgCACEIAIQgABCCAEAIAgAhCACEIAAQggBAtG5dcXNzMz973KtXr+ZHn9f3338/PzqvsoS+MMUltq4Yi60rPhrhnl97DO/fvz/8/PPP87PP55tvvjlcXV3Nzx43/W7d7dYVL1++XHyPTzmePXs2H806S+9xalQsvf5Tjy1aOo9TY8+Wznf0UbH0+lNjrXfv3i2+/lOP3377bT6i82xdAUArQQAgBAGAEAQAQhAACEEAIAQBgBAEAEIQAAhBACAEgf9k2lumMiqWXn9qUHd/f9822CZBACAEAYAQBABCEAAIQQAgBAGAEAQAQhAACEEAIAQBgBCEDVvaMuApxtLWEKdGp6Vje4qxdB5PMUawdL6nxtI5nBp8GQQBgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAuLifliyudHd3d7i+vp6fPe54PB5ubm7mZ4979erV4ZdffpmffT5//PHH/Oi8yurNwhS3vW9F58rUrmOu6Dq/Ec6tovNe29Ln4/3794dvv/12fvb5/PTTT4erq6v52eOm360vXryYnz3uzZs3h8vLy/nZGQ+Tttrt7e00w6vGQxDmV+3T0jmfGiNYOq6nGJ2Wft5eRpeln3VqVCy9/rHRZelnnRp7Nv1+XTrnpfEQhPlV5/mTEQAhCACEIAAQggBACAIAIQgAhCAAEIIAQAgCACEIAETbXkZ8VJjiTe0BM6m878RcfLDn952McMx8UNnLyDcEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAQhAAiNLWFWzXKFsJ7Hmbgq5z6/qIjnAMjMU3BABCEAAIQQAgBAGAEAQAQhAACEEAIAQBgBAEAEIQAIjS1hVb20pgsrVl/yO87yi6rl2XEeZ4a3M26brnK7Z27brmzDcEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAQhAAiNLWFRXVpeBbW5Letcy8ousYOs9thHmr6LovK0a4fzqNcJ1HMML18A0BgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAom3rik6jbMPAOLqu8wgfjy3elyN87ka4J0a4dpXj9Q0BgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAorR1Recy7Mry6oquJeldtrbUfRQjbD3Q9b6MZWu/JyrH6xsCACEIAIQgABCCAEAIAgAhCACEIAAQggBACAIAIQgARGnrilF0Lduu2POWBls73k4jfDy65niUj/7W7qERPh9d1843BABCEAAIQQAgBAGAEAQAQhAACEEAIAQBgBAEAEIQAAhBACBKexnZt6ZfZY67jrfzOm/xmDuMcK9VVOe3cn5d125rc1zR9XvCNwQAQhAACEEAIAQBgBAEAEIQAAhBACAEAYAQBABCEACI3W9dsbUl9Fub48q5TbqW3Fd0HYNz+6jr/CpGmYu1Rpgz3xAACEEAIAQBgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgSltXVIyy1H1ry8xHON6uJf+j6Dq/rV27Tlubty4jXI/KPPiGAEAIAgAhCACEIAAQggBACAIAIQgAhCAAEIIAQAgCAFHauqJryf9ka8vX97zcvqI6D5Xz67rfOu/jDiPMQ6cRjrnrOo8wx5Vz8w0BgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAYpitKypGOY4OW1uav0V7vn+6jLAFwyi67okR7kvfEAAIQQAgBAGAEAQAQhAACEEAIAQBgBAEAEIQAAhBACBKW1dUVJe6j7BFwAjL8yvzsMUtGLrmuGveKrrmuOs6j3C/T0aYty5buyd8QwAgBAGAEAQAQhAACEEAIAQBgBAEAEIQAAhBACAEAYAobV3RuRR8a0u8u3Qdb9e1q85Z5z3UwX3574xwv+39s9TBNwQAQhAACEEAIAQBgBAEAEIQAAhBACAEAYAQBABCEACIYbau6DLCkvQuIyx1r9rzsv8K91q/Ee61yjGMMMe+IQAQggBACAIAIQgAhCAAEIIAQAgCACEIAIQgABCCAEC0bV1RXYa952XmIyxf39oS+qoR7p8RjHAPV40wx1ubt6458w0BgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAorR1xShGWA4+wlL3Ed63057neASjnJtrV1c5twrfEAAIQQAgBAGAEAQAQhAACEEAIAQBgBAEAEIQAAhBACDatq6oLgUfYZl513Lwiq6l+RVbW8Y/2dpcjHC/j8JcfNA1D5X39Q0BgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAQhAAiNJeRl37Z0w633utrn1Stna8FV3nVjXCXFSMMG+jfJ73bJTPx1q+IQAQggBACAIAIQgAhCAAEIIAQAgCACEIAIQgABCCAECUtq6gX9d2Al1bCXRuadB1a44wF6Ncj7W6jnfSdcwVe74elWPwDQGAEAQAQhAACEEAIAQBgBAEAEIQAAhBACAEAYAorVT++++/D//888/8jLW++uqr+dF5XSsQR1mJ2XV+FSPMxSjXY62u4510HXPFnq9H6b58+J9X/993d3eH6+vr+Rlrbe2GL91AxQ9S53vvVdecdd6XI9xve37fLv5kBEAIAgAhCACEIAAQggBACAIAIQgAhCAAEIIAQLStVH7+/Pn8aJ9ev349PzpvhBWII6zEnHS+9151zVnnfTnC/bbn9+3SFoTj8Xi4ubmZn+3PCBe6cgwVXTd81QgfkIo9/1LZ+3Ue4bNU0XVP+JMRACEIAIQgABCCAEAIAgAhCACEIAAQggBACAIAMUQQ3r17N8QA+KLdF9ze3k5roFeN4/E4v+q8ly9fLr7HpxzPnj2bj2adpfc4Nbos/axPPfZu6ZyfYmzN0jl8qaNi6fWnxgj8yQiAEAQAQhAACEEAIAQBgBAEAEIQAAhBACAEAYAQBABCEAZzcXGxetzf33/2sXRcTzUqll5/alQsnfNTjIqlczg1uiydw2OjYun1TzG6LM37qbF0XKfGCAQBgBAEAEIQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAQhA2bGmp/KlRsfT6U6Nqacn+qVGx9PpTo2LpnE+NiqXXnxpL53BqVCz9rKcaW7M0l08xtkYQAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAQhAACEEAIC7uC+ur7+7uDtfX1/Ozxx2Px8PNzc387HG///77/Ojzurq6mh+dV1meX1nC3rXsv2sZffV4RzmODiNc54qua9Fpa5+7Lm2fo4c3Xv3OXUHYoq3dmG03UPF4RzmODiNc54qua9Fpa5+7Ll3Xzp+MAAhBACAEAYAQBABCEAAIQQAgBAGAEAQAQhAAiLaVys+fP58f7dPr16/nR+d1rZjc80rMSddqzC57Xu26xftna0a439uCwEddH7y9f6BH+IBUCAL/xQj3uz8ZARCCAEAIAgAhCACEIAAQggBACAIAIQgAhCAAEKWVyn/++efhr7/+mp+x1uXl5fwIYFylIACwX/5kBEAIAgAhCAA8OBz+D4gsEJlX4zzKAAAAAElFTkSuQmCC" alt="Ã–deme QR Kodu" class="w-full h-full object-cover">
                        </div>

                        <div class="nfc-pulse">
                            <svg width="48" height="48" fill="white" viewBox="0 0 24 24">
                                <path d="M6 9v6h12V9H6zm10 2v2H8v-2h8z"/>
                            </svg>
                        </div>

                        <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4">
                            QR kodu okutun veya telefonunuzu cihaza yaklaÅŸtÄ±rÄ±n
                        </p>

                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600 dark:text-gray-400">AlÄ±cÄ±:</span>
                                <span class="font-semibold text-gray-800 dark:text-gray-100">${volunteerName}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Tutar:</span>
                                <span class="font-bold text-lg text-green-600 dark:text-green-400">Belirsiz</span>
                            </div>
                        </div>

                        <button onclick="handlePayment('${requestId}')" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-105">
                            Ã–demeyi Onayla
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', paymentModalHTML);
        };

        window.closePaymentModal = function () {
            const modal = document.querySelector('.payment-modal');
            if (modal) {
                modal.remove();
            }
        };

        window.handlePayment = function (requestId) {
            const requests = getRequests();
            const reqIndex = requests.findIndex(req => req.id === requestId);

            if (reqIndex !== -1) {
                requests[reqIndex].status = 'Ã–dendi';
                requests[reqIndex].paidAt = Date.now();
                saveRequests(requests);

                document.body.classList.add('payment-success-flash');
                setTimeout(() => {
                    document.body.classList.remove('payment-success-flash');
                }, 800);

                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio playback not available');
                }

                const modalContent = document.querySelector('.payment-modal-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">âœ…</div>
                            <h2 class="text-2xl font-bold text-green-600 dark:text-green-400 mb-2">Ã–deme BaÅŸarÄ±lÄ±!</h2>
                            <p class="text-gray-600 dark:text-gray-400">TeÅŸekkÃ¼r ederiz</p>
                        </div>
                    `;
                }

                setTimeout(() => {
                    closePaymentModal();
                }, 1500);
            }
        };


        // --- DÃœZENLEME, SÄ°LME, MODAL KONTROL MANTIKLARI ---

        window.editRequest = (id, type, currentDetailsJsonString) => {
            if (type === 'shopping') {
                // AlÄ±ÅŸveriÅŸ istekleri iÃ§in gÃ¶rsel editorÃ¼ aÃ§
                openVisualShoppingModal();

                // Mevcut detaylarÄ± yÃ¼kle
                try {
                    const detailsObj = JSON.parse(currentDetailsJsonString);
                    if (detailsObj.type === 'visual_shopping') {
                        // GÃ¶rsel alÄ±ÅŸveriÅŸ verilerini yÃ¼kle
                        selectedProducts = detailsObj.items || [];
                        renderProducts();

                        // Genel notlarÄ± yÃ¼kle
                        const generalNotesInput = document.getElementById('shopping-general-notes');
                        if (generalNotesInput && detailsObj.notes) {
                            generalNotesInput.value = detailsObj.notes;
                        }
                    } else {
                        // Eski metin tabanlÄ± alÄ±ÅŸveriÅŸ verilerini yÃ¼kle
                        const textInput = document.getElementById('shop-item');
                        const detailsInput = document.getElementById('shop-list-details');
                        if (textInput && detailsObj.itemName) {
                            textInput.value = detailsObj.itemName;
                        }
                        if (detailsInput && detailsObj.notes) {
                            detailsInput.value = detailsObj.notes;
                        }
                    }
                } catch (e) {
                    console.error("Detaylar yÃ¼klenirken hata:", e);
                }
            } else {
                // DiÄŸer istek tÃ¼rleri iÃ§in eski sistemi kullan
                window.handleQuickAction(type);
                const titleElement = modalContainer.querySelector('h2');
                if (titleElement) titleElement.textContent += ` (${getTranslation('modal_save')})`;
                const actionButton = document.getElementById('modal-action-btn');
                actionButton.textContent = getTranslation('modal_save');
                actionButton.onclick = () => updateRequest(id, type);

                let detailsObj = {};
                try { detailsObj = JSON.parse(currentDetailsJsonString); } catch (e) { detailsObj = { text: currentDetailsJsonString }; }

                switch (type) {
                    case 'request': document.getElementById('request-details').value = detailsObj.text || ''; break;
                    case 'medication':
                        document.getElementById('med-name').value = detailsObj.itemName || '';
                        document.getElementById('med-time').value = detailsObj.time || '09:00';
                        break;
                    case 'volunteer':
                        document.getElementById('volunteer-notes').value = detailsObj.notes || '';
                        break;
                }
            }
        };

        window.updateRequest = (id, type) => {
            let requests = getRequests();
            const index = requests.findIndex(req => req.id === id);
            if (index === -1) return showMessage('Ä°stek bulunamadÄ±.', 'red');

            let details = {};
            let isFormValid = true;

            try {
                switch (type) {
                    case 'request':
                        details.text = document.getElementById('request-details').value.trim();
                        if (details.text.length < 5) { isFormValid = false; }
                        break;
                    case 'medication':
                        details.itemName = document.getElementById('med-name').value.trim();
                        details.time = document.getElementById('med-time').value.trim();
                        if (!details.itemName || !details.time) { isFormValid = false; }
                        break;
                    case 'volunteer':
                        details.notes = document.getElementById('volunteer-notes').value.trim();
                        if (details.notes.length < 10) { isFormValid = false; }
                        break;
                }

                if (!isFormValid) return;

                const updateData = {
                    details: JSON.stringify(details),
                    timestamp: Date.now()
                };

                requests[index] = { ...requests[index], ...updateData };
                saveRequests(requests);

                showMessage('BaÅŸarÄ±yla gÃ¼ncellendi!', 'green');
                setTimeout(closeModal, 1500);

            } catch (error) {
                console.error("Ä°stek gÃ¼ncellenirken hata oluÅŸtu:", error);
                showMessage('GÃ¼ncelleme hatasÄ±.', 'red');
            }
        };

        window.deleteRequest = (id) => {
            const modalContent = `
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-100">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">${getTranslation('modal_delete')} ${getTranslation('modal_req_title')}</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">${getTranslation('modal_delete_confirm')}</p>
                    <div id="modal-message" class="text-sm text-red-500 mt-2 hidden"></div>
                    <div class="flex justify-end space-x-3 mt-5">
                        <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition">${getTranslation('modal_cancel')}</button>
                        <button onclick="confirmDelete('${id}')" class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-full hover:bg-red-600 transition">${getTranslation('modal_delete')}</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.confirmDelete = (id) => {
            let requests = getRequests();
            requests = requests.filter(req => req.id !== id);
            saveRequests(requests);

            showMessage('BaÅŸarÄ±yla silindi!', 'green');
            setTimeout(closeModal, 1500);
        };

        window.closeModal = () => {
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
            modalContainer.innerHTML = '';
        };

        function showMessage(msg, color) {
            const msgElement = document.getElementById('modal-message');
            if (msgElement) {
                msgElement.textContent = msg;
                const baseClasses = 'text-sm mt-2 p-2 rounded';
                if (color === 'red') {
                    msgElement.className = `${baseClasses} bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300`;
                } else {
                    msgElement.className = `${baseClasses} bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300`;
                }
                msgElement.classList.remove('hidden');
                setTimeout(() => msgElement.classList.add('hidden'), 3000);
            }
        }

        // Ã‡Ä±kÄ±ÅŸ yap
        window.handleLogout = () => {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
                // GÃ¶rev Ã¼reticisini durdur
                if (taskInterval) {
                    clearInterval(taskInterval);
                }

                // Basit Ã§Ä±kÄ±ÅŸ iÅŸlemi - localStorage'Ä± temizle
                localStorage.removeItem(USER_INFO_KEY);
                // SayfayÄ± yenile
                location.reload();
            }
        };

        // --- AYARLAR MODALI ---
        window.openSettingsModal = () => {
            const isDark = document.documentElement.classList.contains('dark');
            const darkToggleChecked = isDark ? 'checked' : '';
            const contrastToggleChecked = isContrastMode ? 'checked' : '';

            const settingsContent = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-100 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-5 text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">${getTranslation('settings_title')}</h2>
                    
                    <div class="space-y-6">
                        <!-- Font Size AyarÄ± -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3">${getTranslation('font_size_title')}</h3>
                            <div class="flex justify-between items-center">
                                <button onclick="changeFontSize('decrease')" class="px-3 py-1 text-sm font-medium text-white bg-primary rounded-lg hover:bg-indigo-600 transition">${getTranslation('font_size_decrease')}</button>
                                <span class="text-sm text-gray-600 dark:text-gray-300">${getTranslation('current_font_size')} <span id="current-font-size-display">${(currentFontSize * 100).toFixed(0)}%</span></span>
                                <button onclick="changeFontSize('increase')" class="px-3 py-1 text-sm font-medium text-white bg-primary rounded-lg hover:bg-indigo-600 transition">${getTranslation('font_size_increase')}</button>
                            </div>
                        </div>

                        <!-- Tema ve Kontrast AyarlarÄ± -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-3">
                            <!-- KaranlÄ±k Mod -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="moon" class="w-5 h-5 text-primary"></i>
                                    <span class="text-gray-800 dark:text-gray-100 font-medium">${getTranslation('dark_mode')}</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" onchange="toggleDarkMode()" ${darkToggleChecked}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            <!-- Kontrast Modu -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="sun-dim" class="w-5 h-5 text-secondary"></i>
                                    <span class="text-gray-800 dark:text-gray-100 font-medium">${getTranslation('contrast_mode_title')}</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" onchange="toggleContrastMode()" ${contrastToggleChecked}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-secondary-300 dark:peer-focus:ring-secondary-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-secondary"></div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Uygulama YardÄ±mÄ±/DokÃ¼mantasyonu -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-3 border-b border-gray-300 dark:border-gray-600 pb-2">${getTranslation('help_title')}</h3>
                            ${renderHelpSection()}
                        </div>
                        
                        <!-- Genel Ayarlar -->
                        <button class="w-full flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="lock" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                                <span class="text-gray-800 dark:text-gray-100">${getTranslation('account_security')}</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </button>

                    </div>

                    <!-- SÃ¼rÃ¼m Bilgisi -->
                    <div class="pt-4 text-center text-xs text-gray-400 dark:text-gray-500">
                        <p>${getTranslation('version')}</p>
                    </div>

                    <div class="flex justify-end mt-5">
                        <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition">${getTranslation('close')}</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = settingsContent;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        function renderHelpSection() {
            return `
                <div class="space-y-3">
                    <div class="text-sm">
                        <p class="font-semibold text-primary">${getTranslation('help_emergency')}</p>
                        <p class="text-gray-600 dark:text-gray-300 text-xs">${getTranslation('help_emergency_desc')}</p>
                    </div>
                    <div class="text-sm">
                        <p class="font-semibold text-primary">${getTranslation('help_general')}</p>
                        <p class="text-gray-600 dark:text-gray-300 text-xs">${getTranslation('help_general_desc')}</p>
                    </div>
                    <div class="text-sm">
                        <p class="font-semibold text-primary">${getTranslation('help_medication')}</p>
                        <p class="text-gray-600 dark:text-gray-300 text-xs">${getTranslation('help_medication_desc')}</p>
                    </div>
                    <div class="text-sm">
                        <p class="font-semibold text-primary">${getTranslation('help_shopping')}</p>
                        <p class="text-gray-600 dark:text-gray-300 text-xs">${getTranslation('help_shopping_desc')}</p>
                    </div>
                </div>
            `;
        }

        // Initialize voices for Web Speech API
        function initVoices() {
            if ('speechSynthesis' in window) {
                // Load voices (some browsers need this to populate the voice list)
                window.speechSynthesis.getVoices();

                // Some browsers fire an event when voices are loaded
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = function () {
                        window.speechSynthesis.getVoices();
                    };
                }
            }
        }

        // --- BAÅLANGIÃ‡ ---
        window.onload = () => {
            // Initialize speech synthesis voices
            initVoices();

            // e-Devlet oturum kontrolÃ¼ (Ã¶nce bunu kontrol et)
            checkEDevletSession();

            // Dil seÃ§icisini kaydettiÄŸimiz deÄŸere ayarla
            document.getElementById('lang-selector').value = currentLang;

            toggleDarkMode(true); // Tema ayarÄ±nÄ± uygula
            applyAccessibilityStyles(); // Font, Kontrast ve KullanÄ±cÄ± AdÄ±nÄ± uygula
            applyLocalization(); // UI'Ä± mevcut dile Ã§evir

            // EÄŸer gÃ¶nÃ¼llÃ¼ ise gÃ¶rev Ã¼reticisini baÅŸlat
            if (currentUserInfo.role === 'volunteer') {
                startTaskGenerator();
            }

            // Ä°lk gÃ¶rÃ¼nÃ¼mÃ¼ yÃ¼kle
            const homeButton = document.querySelector(`.nav-btn:first-child`);
            if (homeButton) viewChange('home', homeButton);
        };
    </script>
</body>

</html>